<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Simplicity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Some thoughts on writing simple code and other random ramblings.">
<meta property="og:type" content="website">
<meta property="og:title" content="Simplicity">
<meta property="og:url" content="http://minhajuddin.com/index.html">
<meta property="og:site_name" content="Simplicity">
<meta property="og:description" content="Some thoughts on writing simple code and other random ramblings.">
<meta property="og:locale">
<meta property="article:author" content="Khaja Minhajuddin">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@minhajuddin">
<link rel="publisher" href="+KhajaMinhajuddin">
  
    <link rel="alternative" href="/atom.xml" title="Simplicity" type="application/atom+xml">
  
  
    <link rel="icon" href="/images/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
  
<link rel="stylesheet" href="/css/style.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-10568795-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



  

  <script>
    function enableSubmit() {
      var btn = document.getElementById('form_submit');
        btn.disabled = false;
        btn.title = '';
    }
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Simplicity</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/about/">About</a>
        
          <a class="main-nav-link" href="/about/#Contact_Me">Contact</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://minhajuddin.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
          
  
    <article id="post-memory-cached-tables-for-building-faster-web-applications" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/31/memory-cached-tables-for-building-faster-web-applications/" class="article-date">
  <time datetime="2021-10-31T21:29:22.000Z" itemprop="datePublished">2021-10-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/31/memory-cached-tables-for-building-faster-web-applications/">Memory Cached Tables for building faster web applications</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Most web apps have a few small tables which don‚Äôt change a lot but are read a
lot from, tables like <code>settings</code> or <code>plans</code> or <code>products</code> (some apps have less than 1000
products). You can do a quick size check of your tables by running the following
query:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- https://stackoverflow.com/a/21738732/24105</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  pg_catalog.pg_namespace.nspname <span class="keyword">AS</span> schema_name,</span><br><span class="line">  relname,</span><br><span class="line">  pg_size_pretty(pg_relation_size(pg_catalog.pg_class.oid)) <span class="keyword">AS</span> tablesize</span><br><span class="line"><span class="keyword">FROM</span> pg_catalog.pg_class</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> pg_catalog.pg_namespace <span class="keyword">ON</span> relnamespace <span class="operator">=</span> pg_catalog.pg_namespace.oid</span><br><span class="line"><span class="keyword">WHERE</span> pg_catalog.pg_namespace.nspname <span class="operator">=</span> <span class="string">&#x27;public&#x27;</span> <span class="keyword">AND</span> pg_catalog.pg_class.reltype</span><br><span class="line"><span class="operator">&lt;&gt;</span> <span class="number">0</span> <span class="keyword">AND</span> relname <span class="keyword">NOT</span> <span class="keyword">LIKE</span> <span class="string">&#x27;%_id_seq&#x27;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">3</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>
<p>At this point you need to decide how much memory in your app you can allocate
for these lookup tables. In my experience for a moderately sized app you could
go as high as 100MB tables. Make sure you add some metrics and benchmark
this before and after doing any optimiztions.</p>
<p>Say you have 4 tables which are small enough to fit in memory, and which you
read a lot from, the first thought that comes to mind is to use caching, and
when someone says caching you reach for redis or memcache or some other network
service. I would ask you to stop and think at this point, How would you cache
in a way that is faster than redis or memcache?</p>
<p>Once you ask that question, the answer becomes obvious, you cache things in your
app‚Äôs memory, if you have any data in your app‚Äôs memory you can just reach for
it. Read this <a target="_blank" rel="noopener" href="https://gist.github.com/jboner/2841832">excellent gist to get a sense of the latency of different kinds of storage strategies</a>.</p>
<p>When using your app‚Äôs memory you don‚Äôt have to pay the network cost plus the
serialization/deserialization tax. Everytime you cache something in redis or
memcached, your app has to make a network call to these services and push out a
serialized version of the data while saving it and do the opposite while reading
it. This cost adds up if you do it on every page load.</p>
<p>I work with an app which keeps a website maintenance flag in memcache and this
ends up adding 30ms to every request that hits our servers. There is a better
way! Move your settings to your app‚Äôs memory. This can easily be done by
defining something like below(in ruby):</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config/initializers/settings.rb</span></span><br><span class="line"><span class="variable">$settings_hash</span> = Setting.all.map&#123;<span class="params">|x|</span> [x.key, x]&#125;.to_h</span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Settings</span></span></span><br><span class="line">  module_function</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">find</span><span class="params">(key)</span></span></span><br><span class="line">    <span class="variable">$settings_hash</span>[key]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>However, as they say one of the two hard problems in computer science is cache
invalidation. What do you do when your data changes? This is the hard part.</p>
<h2 id="Just-restart-it"><a href="#Just-restart-it" class="headerlink" title="Just restart it!"></a>Just restart it!</h2><p>The easiest strategy for this is to restart the server. This might be a
perfectly valid strategy. We do restart our apps when config values change, so
restarting for lookup tables with low frequency changes is a fair strategy.</p>
<h2 id="Poll-for-changes"><a href="#Poll-for-changes" class="headerlink" title="Poll for changes"></a>Poll for changes</h2><p>If that doesn‚Äôt work for your app because your lookup data changes frequently,
let us say every 5 minutes, another strategy is to poll for this data. The
idea is simple:</p>
<ol>
<li>You load your data into a global variable.</li>
<li>You poll for changes in a separate thread using something like
<a target="_blank" rel="noopener" href="https://github.com/brandonhilkert/sucker_punch#executing-jobs-in-the-future">suckerpunch</a>
in ruby and
<a target="_blank" rel="noopener" href="https://viniciuschiele.github.io/flask-apscheduler/rst/usage.html">APScheduler</a>
in python.</li>
</ol>
<h3 id="Content-hash-of-your-table"><a href="#Content-hash-of-your-table" class="headerlink" title="Content hash of your table"></a>Content hash of your table</h3><p>Fortunately there is an easy way to see if there is any change on a table in
postgres, aggregate the whole table into a single text column and then compute
the md5sum of it. This should change any time there is a change to the data.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="comment">/* to avoid random sorting */</span></span><br><span class="line">    MD5(<span class="built_in">CAST</span>((<span class="built_in">ARRAY_AGG</span>(t.<span class="operator">*</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> t)) <span class="keyword">AS</span> text)) content_hash</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">settings t;</span><br></pre></td></tr></table></figure>
<p>Output of this query
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span><br><span class="line">‚îÇ           content_hash           ‚îÇ</span><br><span class="line">‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§</span><br><span class="line">‚îÇ 337f91e1e09b09e96b3413d27102c761 ‚îÇ</span><br><span class="line">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure></p>
<p>Now, all you do is keep a tab on this content hash every 5 minutes or so and
reload the tables when it changes.</p>
<h2 id="Use-Postgres-Subscriptions"><a href="#Use-Postgres-Subscriptions" class="headerlink" title="Use Postgres Subscriptions"></a>Use Postgres Subscriptions</h2><p>Postgres has support for subscriptions, so you could add a mechanism where each
table has a subscription that you push to whenever you modify data using
triggers.
<a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/10/sql-createsubscription.html">https://www.postgresql.org/docs/10/sql-createsubscription.html</a></p>
<h2 id="Use-app-based-pub-sub"><a href="#Use-app-based-pub-sub" class="headerlink" title="Use app based pub/sub"></a>Use app based pub/sub</h2><p>If all your changes go through the app through some kind of admin webpage, you
could also add pub/sub to broadcast an update whenever data is modified to which
all your app servers listen to and refresh the data.</p>
<p>Since elixir and erlang are all about concurrency, they lend themselves nicely
to this idiom. Let us see how this can be done in Elixir.</p>
<h2 id="Manual-cache-invalidation"><a href="#Manual-cache-invalidation" class="headerlink" title="Manual cache invalidation"></a>Manual cache invalidation</h2><p>You could also build a button on your admin console which just pings a specific
endpoint e.g. <code>/admin/:table/cache-invalidate</code> and allow for manual cache
invalidation. The handler for this would just reload the global data.</p>
<p>I feel like the polling strategy is the most robust with the least number of
moving pieces. Please try this out in your app and let me know how this impacts
your performance.</p>
<p>In a future blog post, I‚Äôll explain <a target="_blank" rel="noopener" href="https://github.com/minhajuddin/memory_cached_tables/blob/main/lib/memory_cached_tables/cached_settings.ex">the elixir implemenation</a></p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2021/10/31/memory-cached-tables-for-building-faster-web-applications/" data-id="ckvg57nm1006rcdolgispayk5" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2021/10/31/memory-cached-tables-for-building-faster-web-applications/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/fast/" rel="tag">Fast</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lookup-tables/" rel="tag">Lookup tables</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memory-cached-tables/" rel="tag">Memory Cached Tables</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/performance/" rel="tag">Performance</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/" rel="tag">Ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/speed/" rel="tag">Speed</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web-apps/" rel="tag">Web apps</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-a-baton-server-to-test-your-erlang-elixir-cluster" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/20/a-baton-server-to-test-your-erlang-elixir-cluster/" class="article-date">
  <time datetime="2021-04-20T21:33:26.000Z" itemprop="datePublished">2021-04-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/20/a-baton-server-to-test-your-erlang-elixir-cluster/">A baton server to test your Erlang/Elixir cluster</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I have been dipping my feet into Distributed Systems and <a href="https://minhajuddin.com/2021/04/15/how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard/">set up a cluster of Raspberry Pi Nodes recently</a>.
The first thing I wanted to try was forming an Erlang cluster, And <a target="_blank" rel="noopener" href="https://github.com/bitwalker/libcluster">libcluster</a>
makes this very easy through the Gossip strategy. Here is the code to form the
erlang cluster automatically (as long as it is on the same network).</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.ex</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">children = [</span><br><span class="line">  &#123;Cluster.Supervisor,</span><br><span class="line">   [Application.get_env(<span class="symbol">:herd</span>, <span class="symbol">:topologies</span>), [<span class="symbol">name:</span> Herd.ClusterSupervisor]]&#125;,</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># config/config.exs</span></span><br><span class="line">config <span class="symbol">:herd</span>,</span><br><span class="line">  <span class="symbol">topologies:</span> [</span><br><span class="line">    <span class="comment"># topologies can contain multiple strategies, However, we just have one</span></span><br><span class="line">    <span class="comment"># The name `:gossip` is not important</span></span><br><span class="line">    <span class="symbol">gossip:</span> [</span><br><span class="line">      <span class="comment"># The selected clustering strategy. Required.</span></span><br><span class="line">      <span class="symbol">strategy:</span> Cluster.Strategy.Gossip,</span><br><span class="line">      <span class="comment"># Configuration for the provided strategy. Optional.</span></span><br><span class="line">      <span class="symbol">config:</span> [</span><br><span class="line">        <span class="symbol">port:</span> <span class="number">45892</span>,</span><br><span class="line">        <span class="symbol">if_addr:</span> <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">        <span class="symbol">multicast_if:</span> <span class="string">&quot;192.168.1.1&quot;</span>,</span><br><span class="line">        <span class="symbol">multicast_addr:</span> <span class="string">&quot;230.1.1.251&quot;</span>,</span><br><span class="line">        <span class="symbol">multicast_ttl:</span> <span class="number">1</span>,</span><br><span class="line">        <span class="symbol">secret:</span> <span class="string">&quot;somepassword&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="comment"># The function to use for connecting nodes. The node</span></span><br><span class="line">      <span class="comment"># name will be appended to the argument list. Optional</span></span><br><span class="line">      <span class="symbol">connect:</span> &#123;<span class="symbol">:net_kernel</span>, <span class="symbol">:connect_node</span>, []&#125;,</span><br><span class="line">      <span class="comment"># The function to use for disconnecting nodes. The node</span></span><br><span class="line">      <span class="comment"># name will be appended to the argument list. Optional</span></span><br><span class="line">      <span class="symbol">disconnect:</span> &#123;<span class="symbol">:erlang</span>, <span class="symbol">:disconnect_node</span>, []&#125;,</span><br><span class="line">      <span class="comment"># The function to use for listing nodes.</span></span><br><span class="line">      <span class="comment"># This function must return a list of node names. Optional</span></span><br><span class="line">      <span class="symbol">list_nodes:</span> &#123;<span class="symbol">:erlang</span>, <span class="symbol">:nodes</span>, [<span class="symbol">:connected</span>]&#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>
<p>Once, the clustering was set up I wanted to try sending messages through the
cluster and see how it performed, the simplest test I could think of was a baton
relay. Essentially, I spin up one GenServer per node and it relays a counter to
the next node, which sends it to the next node and so on like the picture below
(psa, psb, psc, and psd are the names of the nodes):</p>
<img src="/2021/04/20/a-baton-server-to-test-your-erlang-elixir-cluster/BatonServer.svg" class="" title="Baton Server Flow">
<p>The code for this ended up being very straightforward. We create a GenServer and
make one of the nodes a <code>main_node</code> so that it can kick off the baton relay.
And, whenever we get a counter with a <code>:pass</code> message we increment the counter
and forward it to the next node. Here is the full code:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Herd.Baton.ErlangProcess</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> GenServer</span><br><span class="line">  <span class="keyword">require</span> Logger</span><br><span class="line"></span><br><span class="line">  <span class="variable">@doc</span> <span class="keyword">false</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_link</span></span>(opts) <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Use &#123;:global, ...&#125; name&#x27;s so that they can be addressed from other nodes</span></span><br><span class="line">    name = global_proc_name(Node.self())</span><br><span class="line">    Logger.info(<span class="string">&quot;starting a baton process&quot;</span>, <span class="symbol">name:</span> inspect(name))</span><br><span class="line">    GenServer.start_link(__MODULE__, opts, <span class="symbol">name:</span> name)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># API to capture the shape of the function that sends a message to the next node</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">pass</span></span>(node, rest_nodes, counter) <span class="keyword">do</span></span><br><span class="line">    GenServer.cast(global_proc_name(node), &#123;<span class="symbol">:pass</span>, rest_nodes, counter&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">@impl</span> <span class="keyword">true</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">init</span></span>(state) <span class="keyword">do</span></span><br><span class="line">    send(<span class="keyword">self</span>(), <span class="symbol">:init</span>)</span><br><span class="line">    &#123;<span class="symbol">:ok</span>, state&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">@impl</span> <span class="keyword">true</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_info</span></span>(<span class="symbol">:init</span>, state) <span class="keyword">do</span></span><br><span class="line">    if main_node?() <span class="keyword">do</span></span><br><span class="line">      if cluster_formed?() <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># Kick off the baton relay if we are the main node</span></span><br><span class="line">        pass(Node.self(), [], <span class="number">1</span>)</span><br><span class="line">      else</span><br><span class="line">        <span class="comment"># check again after 1 second</span></span><br><span class="line">        Process.send_after(<span class="keyword">self</span>(), <span class="symbol">:init</span>, <span class="number">1000</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, state&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Our config has the name of the main node like so:</span></span><br><span class="line">  <span class="comment"># config :herd,</span></span><br><span class="line">  <span class="comment">#   main_node: :herd@psa</span></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">main_node?</span></span>() <span class="keyword">do</span></span><br><span class="line">    Application.get_env(<span class="symbol">:herd</span>, <span class="symbol">:main_node</span>) == Node.self()</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">cluster_formed?</span></span>() <span class="keyword">do</span></span><br><span class="line">    Node.list() != []</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">@impl</span> <span class="keyword">true</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">handle_cast</span></span>(&#123;<span class="symbol">:pass</span>, nodes, counter&#125;, state) <span class="keyword">do</span></span><br><span class="line">    pass_the_baton(nodes, counter)</span><br><span class="line">    &#123;<span class="symbol">:noreply</span>, state&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">pass_the_baton</span></span>([], counter), <span class="symbol">do:</span> pass_the_baton(cluster_nodes(), counter)</span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">pass_the_baton</span></span>([next_node | rest_nodes], counter) <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Datadog guage to show us the change in counter</span></span><br><span class="line">    Datadog.gauge(<span class="string">&quot;baton&quot;</span>, counter, <span class="symbol">tags:</span> host_tags())</span><br><span class="line">    pass(next_node, rest_nodes, counter + <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">host_tags</span></span> <span class="keyword">do</span></span><br><span class="line">    tags(<span class="symbol">host:</span> to_string(Node.self()))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">tags</span></span>(kwlist) <span class="keyword">do</span></span><br><span class="line">    kwlist</span><br><span class="line">    |&gt; Enum.map(<span class="keyword">fn</span> &#123;k, v&#125; -&gt; <span class="string">&quot;<span class="subst">#&#123;k&#125;</span>:<span class="subst">#&#123;v&#125;</span>&quot;</span> <span class="keyword">end</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">global_proc_name</span></span>(node) <span class="keyword">do</span></span><br><span class="line">    &#123;<span class="symbol">:global</span>, &#123;node, __MODULE__&#125;&#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">cluster_nodes</span></span> <span class="keyword">do</span></span><br><span class="line">    [Node.self() | Node.list()]</span><br><span class="line">    |&gt; Enum.shuffle()</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Finally, here is the Datadog graph for the counter, The big thing to note is
that the 4 GenServers on a local lan were able to pass around 100M messages in 8
hours which amounts to about 3.5K messages per second which is impressive:</p>
<img src="/2021/04/20/a-baton-server-to-test-your-erlang-elixir-cluster/datadog-counter.png" class="" title="Datadog Counter Graph">

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2021/04/20/a-baton-server-to-test-your-erlang-elixir-cluster/" data-id="ckvg57nj9000zcdol634h3vvk" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2021/04/20/a-baton-server-to-test-your-erlang-elixir-cluster/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/baton/" rel="tag">Baton</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cluster/" rel="tag">Cluster</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/distributed/" rel="tag">Distributed</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/erlang/" rel="tag">Erlang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/server/" rel="tag">Server</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/libcluster/" rel="tag">libcluster</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/15/how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard/" class="article-date">
  <time datetime="2021-04-15T10:38:57.000Z" itemprop="datePublished">2021-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/15/how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard/">How to show Raspberry Pi temperatures in your Datadog dashboard</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>So, I‚Äôve set up a cluster of 4 Raspberry Pis to learn and experiment with
distributed systems.</p>
<img src="/2021/04/15/how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard/pi-cluster.jpeg" class="" title="My Raspberry Pi Cluster">
<p>I also wanted to track various metrics while running the cluster, so I set up
Datadog APMs on all of them and since the pis usually run hot, I wanted to track
their temperatures for warning signs. Here is how you can send your temperature
info to Datadog.</p>
<p>Create 2 files, a <code>temp.yaml</code> and a <code>temp.py</code> (the names should match).</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/datadog-agent/conf.d/temp.yaml</span></span><br><span class="line"><span class="attr">instances:</span> [&#123;&#125;]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/datadog-agent/checks.d/temp.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="comment"># the following try/except block will make the custom check compatible with any Agent version</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># first, try to import the base class from new versions of the Agent...</span></span><br><span class="line">    <span class="keyword">from</span> datadog_checks.base <span class="keyword">import</span> AgentCheck</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="comment"># ...if the above failed, the check is running in Agent version &lt; 6.6.0</span></span><br><span class="line">    <span class="keyword">from</span> checks <span class="keyword">import</span> AgentCheck</span><br><span class="line"></span><br><span class="line"><span class="comment"># content of the special variable __version__ will be shown in the Agent status page</span></span><br><span class="line">__version__ = <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TempCheck</span>(<span class="params">AgentCheck</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">self, instance</span>):</span></span><br><span class="line">        self.gauge(</span><br><span class="line">            <span class="string">&quot;custom.temperature&quot;</span>,</span><br><span class="line">            (<span class="built_in">int</span>(Path(<span class="string">&quot;/sys/class/thermal/thermal_zone0/temp&quot;</span>).read_text().strip()) / <span class="number">1000</span>),</span><br><span class="line">            tags=[],</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>The meat of this code is the following, where we send a <code>guage</code> metric named
<code>custom.temperature</code> and send it the temperature by reading
<code>/sys/class/thermal/thermal_zone0/temp</code> (this is how you can read the
temperature for a pi with ubuntu installed, you may have to tweak this bit for
other distros)
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.gauge(</span><br><span class="line">    <span class="string">&quot;custom.temperature&quot;</span>,</span><br><span class="line">    (<span class="built_in">int</span>(Path(<span class="string">&quot;/sys/class/thermal/thermal_zone0/temp&quot;</span>).read_text().strip()) / <span class="number">1000</span>),</span><br><span class="line">    tags=[],</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>That‚Äôs it, you can tack other metrics in their too if you‚Äôd like to. You‚Äôll also
need to restart your datadog agent for it to start sending these metrics.</p>
<p>You can <a target="_blank" rel="noopener" href="https://docs.datadoghq.com/developers/metrics/agent_metrics_submission/?tab=count#tutorial">read more about custom metrics in Datadog  here</a>
<img src="/2021/04/15/how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard/dd.png" class="" title="Max of custom.temperature by host"></p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2021/04/15/how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard/" data-id="ckvg57nld0053cdol5nbm7psd" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2021/04/15/how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cluster/" rel="tag">cluster</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/datadog/" rel="tag">datadog</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/raspberry-pi/" rel="tag">raspberry pi</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/temperature/" rel="tag">temperature</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-rename-table-using-pg-dump-or-pg-restore" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/14/how-to-rename-table-using-pg-dump-or-pg-restore/" class="article-date">
  <time datetime="2021-03-14T18:22:43.000Z" itemprop="datePublished">2021-03-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/14/how-to-rename-table-using-pg-dump-or-pg-restore/">How to rename table using pg_dump or pg_restore</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I am in the process of migrating the data from one of my side projects to a
rewritten schema. While doing this, I wanted to keep the old table around with a
different name and do migrations at run time, only when I see someone is using
it. So, I started looking into how I can rename my table while doing a
pg_restore, turns out there is no way to do it. The following is a hacky way to
get it working.</p>
<ol>
<li>Do a <code>pg_dump</code> of your db: <code>pg_dump -Fc --no-acl --no-owner --table forms my_forms_prod &gt; my_forms_prod.pgdump</code></li>
<li>Do a <code>pg_restore</code> into a temporary <code>scratch</code> database <code>pg_restore --verbose --clean --no-acl --no-owner -d scratch my_forms_prod.dump</code></li>
<li>Rename your table: <code>ALTER TABLE forms RENAME TO old_forms;</code></li>
<li>Do another dump: <code>pg_dump -Fc --no-acl --no-owner scratch &gt; my_old_forms_prod.pgdump</code> which will have the ‚ÄúRENAMED‚Äù table :D</li>
<li>Now, you can import this using pg_restore: <code>pg_restore --verbose --clean --no-acl --no-owner -d my_new_forms_prod my_old_forms_prod.dump</code></li>
</ol>
<p>This is just a hack though. Hope you find it useful üòÄ</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2021/03/14/how-to-rename-table-using-pg-dump-or-pg-restore/" data-id="ckvg57nl7004scdol78pv8cem" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2021/03/14/how-to-rename-table-using-pg-dump-or-pg-restore/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pg-dump/" rel="tag">pg_dump</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pg-restore/" rel="tag">pg_restore</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rename/" rel="tag">rename</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/table/" rel="tag">table</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-moving-a-rails-managed-database-to-phoenix" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/07/moving-a-rails-managed-database-to-phoenix/" class="article-date">
  <time datetime="2021-03-07T14:32:11.000Z" itemprop="datePublished">2021-03-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/07/moving-a-rails-managed-database-to-phoenix/">Moving a Rails managed database to Phoenix</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I am moving my app from Rails to Phoenix and as part of this I have to move my
database from being managed by Rails migrations to Phoenix migrations. Here is
how I did it:</p>
<ol>
<li>Rename the <code>schema_migrations</code> table. Phoenix uses Ecto for managing the
database. Ecto and Rails use a table called <code>schema_migrations</code> to store the
database migration info. So, you‚Äôll have to rename it to avoid errors when
you run Ecto migrations.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">psql db</span><br><span class="line">ALTER TABLE schema_migrations RENAME TO rails_schema_migrations</span><br></pre></td></tr></table></figure></li>
<li>After this, you‚Äôll need to create the schema_migrations table for ecto, you
can do it by running the <code>mix ecto.create</code> command. This will set up the
<code>schema_migrations</code> table in the existing database.</li>
</ol>
<p>Now, you‚Äôve successfully migrated your database. And, you can run your
Phoenix/Ecto migrations like you would in a normal phoenix app.</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2021/03/07/moving-a-rails-managed-database-to-phoenix/" data-id="ckvg57nm3006ucdola8e903kv" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2021/03/07/moving-a-rails-managed-database-to-phoenix/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/database/" rel="tag">Database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ecto/" rel="tag">Ecto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/migration/" rel="tag">Migration</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/phoenix/" rel="tag">Phoenix</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rails/" rel="tag">Rails</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-a-simple-way-to-store-secrets-using-parameter-store-for-your-ecs-applications" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/07/a-simple-way-to-store-secrets-using-parameter-store-for-your-ecs-applications/" class="article-date">
  <time datetime="2021-03-07T13:52:40.000Z" itemprop="datePublished">2021-03-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/07/a-simple-way-to-store-secrets-using-parameter-store-for-your-ecs-applications/">A simple way to store secrets using Parameter Store for your ECS applications</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I have an ECS cluster for my side projects and need to pass secrets to the app.
There are a few ways of doing it, and I think I found a nice balance between
simplicity and ease of use.</p>
<h2 id="Wrong-ways-of-sharing-secrets"><a href="#Wrong-ways-of-sharing-secrets" class="headerlink" title="Wrong ways of sharing secrets"></a>Wrong ways of sharing secrets</h2><p>There are a few wrong ways of sharing secrets, Make sure you don‚Äôt do any of
these üôÇ</p>
<ol>
<li><em>Secrets in source code</em>: This is a big no-no, you don‚Äôt want to store
secrets in your code because anyone with access to your code will be able to
read them.</li>
<li><em>Secrets built into the docker image</em>: This is another bad idea, because
anyone with access to your images will have your secrets, moreover, if you
want to change a secret, you‚Äôll have to build a new image and deploy it.</li>
<li><em>Secrets in the terraform ECS task definitions Environment block</em>: This is
not very bad, but anyone with access to your terraform repo will be able to
read your secrets.</li>
</ol>
<h2 id="Store-Secrets-in-the-parameter-store-one-parameter-per-secret"><a href="#Store-Secrets-in-the-parameter-store-one-parameter-per-secret" class="headerlink" title="Store Secrets in the parameter store, one parameter per secret"></a>Store Secrets in the parameter store, one parameter per secret</h2><p>The parameter store is a <em>free</em> and easy tool to save your secrets. There are
more fancy options like the secret manager, but they cost money.</p>
<p>One way of storing secrets is to create one parameter per environment variable,
e.g. if you have an app called money, you could create parameters called
<code>money_database_url</code>, <code>money_secret_access_token</code> etc,. Make sure you create
them as ‚ÄòSecretString‚Äô types. And then in your task definition. Use the
following code:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;money-web&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;...&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cpu&quot;</span>: <span class="number">256</span>,</span><br><span class="line">    <span class="attr">&quot;memory&quot;</span>: <span class="number">512</span>,</span><br><span class="line">    <span class="attr">&quot;essential&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;portMappings&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;containerPort&quot;</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">&quot;hostPort&quot;</span>: <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;secrets&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;DATABASE_URL&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;valueFrom&quot;</span>: <span class="string">&quot;money_database_url&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;SECRET_ACCESS_TOKEN&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;valueFrom&quot;</span>: <span class="string">&quot;money_secret_access_token&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;environment&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;MIX_ENV&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;prod&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>This will make your secrets available to your ECS container via environment
variables called <code>DATABASE_URL</code> and <code>SECRET_ACCESS_TOKEN</code>. However, if you have
lots of secrets, this becomes unweildy.</p>
<h2 id="Store-Secrets-in-the-parameter-store-one-parameter-per-app"><a href="#Store-Secrets-in-the-parameter-store-one-parameter-per-app" class="headerlink" title="Store Secrets in the parameter store, one parameter per app"></a>Store Secrets in the parameter store, one parameter per app</h2><p>I create a file called <code>secrets.json</code> with all the secrets (You can tweak this
step, and use some other format)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;db&quot;</span>:<span class="string">&quot;ecto://user:password@endpoint/dbname&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;secret_key_base&quot;</span>:<span class="string">&quot;....&quot;</span>,</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Once I have all the secrets listed in this file. I pass it through the following
command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jq -c . &lt; &quot;secrets.json&quot; | base64 --wrap 0</span><br></pre></td></tr></table></figure>
<p>This strips the spaces in the json and base64 encodes it. I plug this value into
a single parameter called <code>money_config</code> and then use the same strategy as
before to pass it as an env var:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;secrets&quot;</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;APP_CONFIG&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;valueFrom&quot;</span>: <span class="string">&quot;money_config&quot;</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p>Now, in the app, I just decode base64 and then decode the json to get all the
values. Here is how I do it in my Elixir apps:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># config/releases.exs</span><br><span class="line">import Config</span><br><span class="line"></span><br><span class="line">app_config = System.fetch_env!(&quot;APP_CONFIG&quot;) |&gt; Base.decode64!() |&gt; Jason.decode!()</span><br><span class="line"></span><br><span class="line">config :money, Money.Repo,</span><br><span class="line">  ssl: true,</span><br><span class="line">  url: Map.fetch!(app_config, &quot;db&quot;),</span><br><span class="line">  pool_size: String.to_integer(System.get_env(&quot;POOL_SIZE&quot;, &quot;10&quot;))</span><br><span class="line"></span><br><span class="line">config :money, MoneyWeb.Endpoint,</span><br><span class="line">  http: [</span><br><span class="line">    port: 8000,</span><br><span class="line">    transport_options: [socket_opts: [:inet6]]</span><br><span class="line">  ],</span><br><span class="line">  server: true,</span><br><span class="line">  secret_key_base: Map.fetch!(app_config, &quot;secret_key_base&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>This approach allows you to use around 70 secrets in one parameter because paramater values are limited to a size of 4K characters.</p>
<h2 id="Making-space-for-more-environment-variables"><a href="#Making-space-for-more-environment-variables" class="headerlink" title="Making space for more environment variables"></a>Making space for more environment variables</h2><p>If you have more than 70 environment variables you can add <code>gzip</code> to the pipe to get in more environment variables in a single parameter.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jq -c . &lt; &quot;secrets.json&quot; | gzip | base64 --wrap 0</span><br></pre></td></tr></table></figure>
<p>You‚Äôll have to do things in the opposite order on your app to read this data. With gzip, You can get almost 140 env variables.</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2021/03/07/a-simple-way-to-store-secrets-using-parameter-store-for-your-ecs-applications/" data-id="ckvg57nje0018cdolfvsy5rh6" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2021/03/07/a-simple-way-to-store-secrets-using-parameter-store-for-your-ecs-applications/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/" rel="tag">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ecs/" rel="tag">ECS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/environment-variables/" rel="tag">Environment Variables</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/parameter-store/" rel="tag">Parameter Store</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/secrets/" rel="tag">Secrets</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/terraform/" rel="tag">Terraform</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-do-batch-updates-in-postgresql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/17/how-to-do-batch-updates-in-postgresql/" class="article-date">
  <time datetime="2020-10-17T08:30:53.000Z" itemprop="datePublished">2020-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/17/how-to-do-batch-updates-in-postgresql/">How to do batch updates in postgresql for really big updates</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>So, you have a ton of records to update in a really large table. Say, you need
to update 3 million records in a table with 100 million rows. And, let‚Äôs also
assume that you have a way of finding these records. Even, with all of this
info, updating 3M records in a single transaction is troublesome if your table
is being used moderately during this data fix. You have a high probability of
running into a deadlock or your query timing out.</p>
<p>There is a way you can do this by updating your data in small batches. The idea
is to first find the ids of the records you want to update and then updating a
small batch of them in each transaction.</p>
<p>For our example, let us say we have a <code>users</code> table which has 3M records created
in the year 2019 whose authentication token needs to be reset. Simple enough!</p>
<h2 id="1-Doing-this-in-a-single-update"><a href="#1-Doing-this-in-a-single-update" class="headerlink" title="1. Doing this in a single update"></a>1. Doing this in a single update</h2><p>Doing this in a single update is the easiest and is possible if you don‚Äôt use
this table a lot. However, as I said, it is prone to deadlocks and statement
timeouts.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users</span><br><span class="line"><span class="keyword">SET</span> authentication_token <span class="operator">=</span> encode(gen_random_bytes(<span class="number">32</span>), <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line"><span class="keyword">WHERE</span> created_at <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-Doing-this-in-multiple-batches-through-a-CTE"><a href="#2-Doing-this-in-multiple-batches-through-a-CTE" class="headerlink" title="2. Doing this in multiple batches through a CTE"></a>2. Doing this in multiple batches through a CTE</h3><p>Doing this through a CTE in multiple batches works, but is not the most
efficient.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- first get all the records that you want to update by using rolling OFFSETs</span></span><br><span class="line"><span class="comment">-- and limiting to a nice batch size using LIMIT</span></span><br><span class="line"><span class="keyword">WITH</span> users_to_be_updated (</span><br><span class="line">  <span class="keyword">SELECT</span> id</span><br><span class="line">  <span class="keyword">FROM</span> users</span><br><span class="line">  <span class="keyword">WHERE</span> created_at <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-12-31&#x27;</span></span><br><span class="line">  LIMIT <span class="number">1000</span></span><br><span class="line">  <span class="keyword">OFFSET</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br><span class="line">)</span><br><span class="line">UPDATE users u</span><br><span class="line"><span class="keyword">SET</span> authentication_token <span class="operator">=</span> encode(gen_random_bytes(<span class="number">32</span>), <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> users_to_be_updated utbu</span><br><span class="line"><span class="keyword">WHERE</span> utbu.id <span class="operator">=</span> u.id</span><br></pre></td></tr></table></figure>
<p>That works. However, it is not the most efficient update. Because, for every
batch, (in this example a batch of 1000) we perform the filtering and ordering
of all the data. So, we end up making the same query 3M/1K or 3000 times. Not
the most efficient use of our database resources!</p>
<h3 id="3-1-Doing-this-in-multiple-batches-using-a-temporary-table"><a href="#3-1-Doing-this-in-multiple-batches-using-a-temporary-table" class="headerlink" title="3.1. Doing this in multiple batches using a temporary table"></a>3.1. Doing this in multiple batches using a temporary table</h3><p>So, to remove the inefficiency from the previous step, we can create a temporary table to
store the filtered user ids while we update the records. Also, since this is a
temp table, it is discarded automatically once the session finishes.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TABLE</span> users_to_be_updated <span class="keyword">AS</span></span><br><span class="line">  <span class="keyword">SELECT</span> <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> id) row_id, id</span><br><span class="line">  <span class="keyword">FROM</span> users</span><br><span class="line">  <span class="keyword">WHERE</span> created_at <span class="keyword">BETWEEN</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2019-12-31&#x27;</span>;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">CREATE</span> INDEX <span class="keyword">ON</span> users_to_be_updated(row_id);</span><br><span class="line"></span><br><span class="line">UPDATE users u</span><br><span class="line"><span class="keyword">SET</span> authentication_token <span class="operator">=</span> encode(gen_random_bytes(<span class="number">32</span>), <span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> users_to_be_updated utbu</span><br><span class="line"><span class="keyword">WHERE</span> utbu.id <span class="operator">=</span> u.id</span><br><span class="line"><span class="keyword">AND</span> utbu.row_id <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">AND</span> utbu.row_id  <span class="operator">&lt;=</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p>So, in the above SQL we are creating a temporary table containing a row_id which
is a serial number going from 1 to the total number of rows and also adding an
index on this because we‚Äôll be using it in our batch update WHERE clause. And,
finally doing our batch update by selecting the rows from 0..1000 in the first
iteration, 1000..2000 in the second iteration, and so on.</p>
<h3 id="3-2-Tying-this-up-via-a-ruby-script-to-do-the-full-update"><a href="#3-2-Tying-this-up-via-a-ruby-script-to-do-the-full-update" class="headerlink" title="3.2. Tying this up via a ruby script to do the full update."></a>3.2. Tying this up via a ruby script to do the full update.</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sql_generator.rb</span></span><br><span class="line">total_count = <span class="number">3_000_000</span></span><br><span class="line">batch_size = <span class="number">10_000</span></span><br><span class="line"></span><br><span class="line">iterations = <span class="number">1</span> + total_count / batch_size</span><br><span class="line"></span><br><span class="line">puts <span class="string">&lt;&lt;~SQL</span></span><br><span class="line"><span class="string">-- create our temporary table to avoid running this query for every batch update</span></span><br><span class="line"><span class="string">CREATE TEMP TABLE users_to_be_updated AS</span></span><br><span class="line"><span class="string">  SELECT ROW_NUMBER() OVER(ORDER BY id) row_id, id</span></span><br><span class="line"><span class="string">  FROM users</span></span><br><span class="line"><span class="string">  WHERE created_at BETWEEN &#x27;2019-01-01&#x27; AND &#x27;2019-12-31&#x27;;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">-- create an index on row_id because we&#x27;ll filter rows by this</span></span><br><span class="line"><span class="string">CREATE INDEX ON users_to_be_updated(row_id);</span></span><br><span class="line"><span class="string">SQL</span></span><br><span class="line"></span><br><span class="line">(<span class="number">0</span>..iterations).each <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">  start_id = i * batch_size</span><br><span class="line">  end_id = (i + <span class="number">1</span>) * batch_size</span><br><span class="line">  puts <span class="string">&lt;&lt;~SQL</span></span><br><span class="line"><span class="string">-- the row below prints out the current iteration which shows us the progress</span></span><br><span class="line"><span class="string">-- batch: <span class="subst">#&#123;i&#125;</span>/<span class="subst">#&#123;iterations&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- start a transaction for this batch update</span></span><br><span class="line"><span class="string">BEGIN;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- perform the actual batch update</span></span><br><span class="line"><span class="string">UPDATE users u</span></span><br><span class="line"><span class="string">SET authentication_token = encode(gen_random_bytes(32), &#x27;base64&#x27;)</span></span><br><span class="line"><span class="string">FROM users_to_be_updated utbu</span></span><br><span class="line"><span class="string">WHERE utbu.id = u.id</span></span><br><span class="line"><span class="string">AND utbu.row_id &gt; <span class="subst">#&#123;start_id&#125;</span> AND utbu.row_id  &lt;= <span class="subst">#&#123;end_id&#125;</span>;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- commit this transaction so that we don&#x27;t have a single long running transaction</span></span><br><span class="line"><span class="string">COMMIT;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-- This is optional, sleep for 1 second to stop the database from being overwhelmed.</span></span><br><span class="line"><span class="string">-- You can tweak this to your desire time based on the resources you have or</span></span><br><span class="line"><span class="string">-- remove it.</span></span><br><span class="line"><span class="string">SELECT pg_sleep(1);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">SQL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>This tiny script generates a sql file which can then be executed via psql to do
the whole process in one fell swoop.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># generate the sql file</span></span><br><span class="line">ruby sql_generator.rb &gt; user_batch_update.sql</span><br></pre></td></tr></table></figure>
<p>Once we have the sql file we run it through psql like so</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql --echo-all --file=user_batch_update.psql <span class="string">&quot;DATABASE_URL&quot;</span></span><br></pre></td></tr></table></figure>
<p>That‚Äôs all folks, now your updates should be done in batches and shouldn‚Äôt cause
any deadlocks or statement timeouts.</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/10/17/how-to-do-batch-updates-in-postgresql/" data-id="ckvg57nkn003rcdol5icn4xwy" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/10/17/how-to-do-batch-updates-in-postgresql/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/batch/" rel="tag">batch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/psql/" rel="tag">psql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/row-number/" rel="tag">row_number</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/temp-table/" rel="tag">temp table</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/update/" rel="tag">update</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-lazy-functional-ruby" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/29/lazy-functional-ruby/" class="article-date">
  <time datetime="2020-07-29T07:55:10.000Z" itemprop="datePublished">2020-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/29/lazy-functional-ruby/">Lazy functional ruby</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Today, I was working with some ruby code that had to find the first product in
one of the current contexts. Here is the code:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_product_in_current_contexts</span></span></span><br><span class="line">  context_ids = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">  context_ids.each <span class="keyword">do</span> <span class="params">|context_id|</span></span><br><span class="line">    product = Product.find_by(<span class="symbol">context_id:</span> context_id)</span><br><span class="line">    <span class="keyword">return</span> product <span class="keyword">if</span> product</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>This code tries to find the first product in the current contexts in the order
they are defined. However, the above code has a tiny bug. Can you figure out
what it is?</p>
<p>In cases where there are no products in any of the contexts this function
returns the array <code>[1, 2, 3]</code> instead of returning <code>nil</code> because <code>Array.each</code>
returns the array and in the case where we don‚Äôt find the product we don‚Äôt
return early.</p>
<p>We can easily fix this by adding an extra return at the end of the function.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_product_in_current_contexts</span></span></span><br><span class="line">  context_ids = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">  context_ids.each <span class="keyword">do</span> <span class="params">|context_id|</span></span><br><span class="line">    product = Product.find_by(<span class="symbol">context_id:</span> context_id)</span><br><span class="line">    <span class="keyword">return</span> product <span class="keyword">if</span> product</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># if it reaches this point we haven&#x27;t found a product</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>The fix is awkward, let us see if we can improve this.</p>
<p>We could use <code>.map</code> to find a product for every context and return the first not
<code>nil</code> record like so:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_product_in_current_contexts</span></span></span><br><span class="line">  context_ids = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">  context_ids</span><br><span class="line">    .map &#123; <span class="params">|context_id|</span> Product.find_by(<span class="symbol">context_id:</span> context_id)&#125;</span><br><span class="line">    .find&#123;<span class="params">|x|</span> x &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>This looks much cleaner! And it doesn‚Äôt have the previous bug either. However,
this code is not efficient, we want to return the first product we find for all
the contexts, and the above code always looks in all contexts even if it finds a
product for the first context. We need to be lazy!</p>
<h2 id="Lazy-enumerator-for-the-win"><a href="#Lazy-enumerator-for-the-win" class="headerlink" title="Lazy enumerator for the win!"></a>Lazy enumerator for the win!</h2><p>Calling <code>.lazy</code> on an enumerable gives you a lazy enumerator and the neat thing
about that is it only executes the chain of functions as many times as needed.</p>
<p>Here is a short example which demonstrates its use:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find</span><span class="params">(id)</span></span></span><br><span class="line">  puts <span class="string">&quot;&gt; finding <span class="subst">#&#123;id&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="symbol">:product</span> <span class="keyword">if</span> id == <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># without lazy</span></span><br><span class="line">(<span class="number">1</span>..<span class="number">3</span>).map&#123;<span class="params">|id|</span> find(id)&#125;.find&#123;<span class="params">|x|</span> x&#125;</span><br><span class="line"><span class="comment"># &gt; finding 1</span></span><br><span class="line"><span class="comment"># &gt; finding 2</span></span><br><span class="line"><span class="comment"># &gt; finding 3</span></span><br><span class="line"><span class="comment"># =&gt; :product</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The above `.map` gets executed for every element in the range every time!</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># using the lazy enumerator</span></span><br><span class="line">(<span class="number">1</span>..<span class="number">3</span>).lazy.map&#123;<span class="params">|id|</span> find(id)&#125;.find&#123;<span class="params">|x|</span> x&#125;</span><br><span class="line"><span class="comment"># &gt; finding 1</span></span><br><span class="line"><span class="comment"># &gt; finding 2</span></span><br><span class="line"><span class="comment"># =&gt; :product</span></span><br></pre></td></tr></table></figure>
<p>As you can see from the above example, the lazy enumerator executes only as many
times as necessary. Here is another example from the ruby docs, to drive the
point home:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">irb&gt; (<span class="number">1</span>..Float::INFINITY).lazy.select(&amp;<span class="symbol">:odd?</span>).drop(<span class="number">10</span>).take(<span class="number">2</span>).to_a</span><br><span class="line"><span class="comment"># =&gt; [21, 23]</span></span><br><span class="line"><span class="comment"># Without the lazy enumerator, this would crash your console!</span></span><br></pre></td></tr></table></figure>
<p>Now applying this to our code is pretty straightforward, we just need to add a
call to <code>#.lazy</code> before we map and we are all set!</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_product_in_current_contexts</span></span></span><br><span class="line">  context_ids = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">  context_ids</span><br><span class="line">    .lazy <span class="comment"># this gives us the lazy enumerator</span></span><br><span class="line">    .map &#123; <span class="params">|context_id|</span> Product.find_by(<span class="symbol">context_id:</span> context_id)&#125;</span><br><span class="line">    .find&#123;<span class="params">|x|</span> x &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Ah, nice functional ruby!</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/07/29/lazy-functional-ruby/" data-id="ckvg57nls0065cdol81rafz6y" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/07/29/lazy-functional-ruby/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/functional/" rel="tag">functional</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lazy/" rel="tag">lazy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/" rel="tag">ruby</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-know-which-of-the-enum-functions-to-use-in-elixir" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/18/how-to-know-which-of-the-enum-functions-to-use-in-elixir/" class="article-date">
  <time datetime="2020-07-18T09:36:39.000Z" itemprop="datePublished">2020-07-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/18/how-to-know-which-of-the-enum-functions-to-use-in-elixir/">How to know which of the Enum functions to use in Elixir</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>When you are writing functional code, it is sometimes difficult to figure out
which of the <code>Enum</code> functions you want to use. Here are a few common use cases.</p>
<h2 id="Use-Enum-map"><a href="#Use-Enum-map" class="headerlink" title="Use Enum.map"></a>Use <code>Enum.map</code></h2><p>You can use <code>Enum.map</code> when you want to <em>transform</em> a set of elements into
another set of elements. Also, note that the count of elements remains
unchanged. So, if you transform a list of 5 elements using <code>Enum.map</code>, you get
an output list containing exactly 5 elements, However, the shape of the elements
might be different.</p>
<h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># transform names into their lengths</span></span><br><span class="line">iex&gt; Enum.map([<span class="string">&quot;jack&quot;</span>, <span class="string">&quot;mujju&quot;</span>, <span class="string">&quot;danny boy&quot;</span>], <span class="keyword">fn</span> x -&gt; String.length(x) <span class="keyword">end</span>)</span><br><span class="line">[<span class="number">4</span>, <span class="number">5</span>, <span class="number">9</span>]</span><br></pre></td></tr></table></figure>
<p>If you look at the count of input and output elements it remains the same,
However, the shape is different, the input elements are all strings whereas the
output elements are all numbers.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get ids of all users from a list of structs</span></span><br><span class="line">iex&gt; Enum.map([%&#123;<span class="symbol">id:</span> <span class="number">1</span>, <span class="symbol">name:</span> <span class="string">&quot;Danny&quot;</span>&#125;, %&#123;<span class="symbol">id:</span> <span class="number">2</span>, <span class="symbol">name:</span> <span class="string">&quot;Mujju&quot;</span>&#125;], <span class="keyword">fn</span> x -&gt; x.id <span class="keyword">end</span>)</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>In this example we transform a list of maps to a list of numbers.</p>
<h2 id="Use-Enum-filter"><a href="#Use-Enum-filter" class="headerlink" title="Use Enum.filter"></a>Use <code>Enum.filter</code></h2><p>When you want to whittle down your input list, use <code>Enum.filter</code>, Filtering
doesn‚Äôt change the shape of the data, i.e. you are not transforming elements,
and the shape of the input data will be the same as the shape of the output
data. However, the count of elements will be different, to be more precise it
will be lesser or the same as the input list count.</p>
<h3 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples"></a>Examples</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filter a list to only get names which start with `m`</span></span><br><span class="line">iex&gt; Enum.filter([<span class="string">&quot;mujju&quot;</span>, <span class="string">&quot;danny&quot;</span>, <span class="string">&quot;min&quot;</span>, <span class="string">&quot;moe&quot;</span>, <span class="string">&quot;boe&quot;</span>, <span class="string">&quot;joe&quot;</span>], <span class="keyword">fn</span> x -&gt; String.starts_with?(x, <span class="string">&quot;m&quot;</span>) <span class="keyword">end</span>)</span><br><span class="line">[<span class="string">&quot;mujju&quot;</span>, <span class="string">&quot;min&quot;</span>, <span class="string">&quot;moe&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>The shape of data here is the same, we use a list of strings as the input and
get a list of strings as an output, only the count has changed, in this case, we
have fewer elements.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filter a list of users to only get active users</span></span><br><span class="line">iex&gt; Enum.filter([%&#123;<span class="symbol">id:</span> <span class="number">1</span>, <span class="symbol">name:</span> <span class="string">&quot;Danny&quot;</span>, <span class="symbol">active:</span> <span class="keyword">true</span>&#125;, %&#123;<span class="symbol">id:</span> <span class="number">2</span>, <span class="symbol">name:</span> <span class="string">&quot;Mujju&quot;</span>, <span class="symbol">active:</span> <span class="keyword">false</span>&#125;], <span class="keyword">fn</span> x -&gt; x.active <span class="keyword">end</span>)</span><br><span class="line">[%&#123;<span class="symbol">active:</span> <span class="keyword">true</span>, <span class="symbol">id:</span> <span class="number">1</span>, <span class="symbol">name:</span> <span class="string">&quot;Danny&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>In this example too, the shape of the input elements is a map (user) and the
shape of output elements is still a map.</p>
<h2 id="Use-Enum-reduce"><a href="#Use-Enum-reduce" class="headerlink" title="Use Enum.reduce"></a>Use <code>Enum.reduce</code></h2><p>The last of the commonly used <code>Enum</code> functions is <code>Enum.reduce</code> and it is also
one of the most powerful functions. You can use <code>Enum.reduce</code> when you need to
change the shape of the input list into something else, for instance a <code>map</code> or a
<code>number</code>.</p>
<h3 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples"></a>Examples</h3><p>Change a list of elements into a number by computing its product or sum</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; Enum.reduce(</span><br><span class="line">  _input_enumberable = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">  _start_value_of_acc = <span class="number">1</span>,</span><br><span class="line">  <span class="keyword">fn</span> x, acc -&gt; x * acc <span class="keyword">end</span>)</span><br><span class="line"><span class="number">24</span></span><br><span class="line"></span><br><span class="line">iex&gt; Enum.reduce(</span><br><span class="line">  _input_list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">  _start_value_of_acc = 0,</span><br><span class="line">  <span class="keyword">fn</span> x, acc -&gt; x + acc <span class="keyword">end</span>)</span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure>
<p><code>Enum.reduce</code> takes three arguments, the first is the input enumerable, which is
usually a list or map, the second is the starting value of the accumulator and
the third is a function which is applied for each element
<strong>whose result is then sent to the next function application as the accumulator</strong>.</p>
<p>Let‚Äôs try and understand this using an equivalent javascript example.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// input list</span></span><br><span class="line"><span class="keyword">const</span> inputList = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// starting value of accumulator, we want to chose this wisely, for instance</span></span><br><span class="line"><span class="comment">// when we want addition, we should use a `0` as the start value to avoid</span></span><br><span class="line"><span class="comment">// impacting the output and if you want to compute a product we use a `1`, this</span></span><br><span class="line"><span class="comment">// is usually called the identity element for the function: https://en.wikipedia.org/wiki/Identity_element</span></span><br><span class="line"><span class="comment">// It is also the value that is returned when the input list is empty</span></span><br><span class="line"><span class="keyword">let</span> acc = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// loop over all the input elements and for each element compute the new</span></span><br><span class="line"><span class="comment">// accumulator as the sum of the current accumulator and the current element</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> x <span class="keyword">of</span> inputList) &#123;</span><br><span class="line">  <span class="comment">// compute the next value of our accumulator, in our Elixir code this is</span></span><br><span class="line">  <span class="comment">// done by the third argument which is a function which gets `x` and `acc`</span></span><br><span class="line">  acc = acc + x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// in Elixir, the final value of the accumulator is returned</span></span><br></pre></td></tr></table></figure>
<p>Let‚Äôs look at another example of converting an employee list into a map
containing an employee id and their name.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iex&gt; Enum.reduce(</span><br><span class="line">  _input_list = [%&#123;<span class="symbol">id:</span> <span class="number">1</span>, <span class="symbol">name:</span> <span class="string">&quot;Danny&quot;</span>&#125;, %&#123;<span class="symbol">id:</span> <span class="number">2</span>, <span class="symbol">name:</span> <span class="string">&quot;Mujju&quot;</span>&#125;],</span><br><span class="line">  _start_value_of_acc = %&#123;&#125;,</span><br><span class="line">  <span class="keyword">fn</span> x, acc -&gt; Map.put(acc, x.id, x.name) <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">%&#123;<span class="number">1</span> =&gt; <span class="string">&quot;Danny&quot;</span>, <span class="number">2</span> =&gt; <span class="string">&quot;Mujju&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>So, in a map you end up reducing an input list into one output value.</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/07/18/how-to-know-which-of-the-enum-functions-to-use-in-elixir/" data-id="ckvg57nl3004jcdol5eyz928r" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/07/18/how-to-know-which-of-the-enum-functions-to-use-in-elixir/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/enum/" rel="tag">Enum</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/functional-programming/" rel="tag">Functional Programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/filter/" rel="tag">filter</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/map/" rel="tag">map</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/reduce/" rel="tag">reduce</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-control-enqueuing-speed-of-sidekiq-jobs-and-their-execution-concurrency" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/13/how-to-control-enqueuing-speed-of-sidekiq-jobs-and-their-execution-concurrency/" class="article-date">
  <time datetime="2020-07-13T18:55:04.000Z" itemprop="datePublished">2020-07-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/13/how-to-control-enqueuing-speed-of-sidekiq-jobs-and-their-execution-concurrency/">How to control the enqueuing speed of Sidekiq jobs and their concurrency</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>At my work, we use ruby heavily and sidekiq is an essential part of our stack.
Sometimes, I long for the concurrency primitives from Elixir, but that‚Äôs not
what today‚Äôs post is about.</p>
<p>A few days ago, I caused a minor incident by overloading our databases. Having
been away from ruby for a bit, I had forgotten that sidekiq runs multiple
threads per each worker instance. So, I ended up enqueuing about 10K jobs on
Sidekiq, and Sidekiq started executing them immediately. We have 50 worker
instances and run Sidekiq with a concurrency of 20. So, essentially we had 400
worker threads ready to start crunching these jobs. Coincidentally we have 400
database connections available and my batch background job ended up consuming
all the connections for 5 minutes during which the other parts of
the application were connection starved and started throwing errors üò¨.</p>
<p>That was a dumb mistake. Whenever you find yourself making a dumb mistake,
make sure that no one else can repeat that mistake. To fix that, we could set up
our database with multiple users in such a way that the web app would connect
with a user which could only open a maximum of 100 connections, the background
worker with a user with its own limits and, so on. This would stop these kinds of
problems from happening again. However, we‚Äôll get there when we get there, as
this would require infrastructure changes.</p>
<p>I had another batch job lined up which had to process millions of rows in a
similar fashion. And, I started looking for solutions. A few solutions that were
suggested were to run these jobs on a single worker or a small set of workers,
you can do this by having a custom queue for this job and executing a separate
sidekiq instance just for this one queue. However, that would require some
infrastructure work. So, I started looking at other options.</p>
<p>I thought that redis might have something to help us here, and it did! So, redis
allows you to make blocking pops from a list using the <code>BLPOP</code> function. So, if
you run <code>BLPOP myjob 10</code>, it will pop the first available element in the list,
However, if the list is empty, it will block for 10 seconds during which if an
element is inserted, it will pop it and return its value. Using this knowledge,
I thought we could control the enqueuing based on the elements in the list. The
idea is simple.</p>
<ol>
<li>Before the background job starts, I would seed this list with <code>n</code> elements
where <code>n</code> is the desired concurrency. So, if I seed this list with <code>2</code>
elements, Sidekiq would execute only 2 jobs at any point in time, regardless
of the number of worker instances/concurrency of sidekiq workers.</li>
<li>The way this is enforced is by the enqueue function using a <code>BLPOP</code> before it
enqueues, so, as soon as the enqueuer starts, it pops the first 2 elements from
the redis list and enqueues 2 jobs. At this point, the enqueuer is stuck till we
add more elements to the list.</li>
<li>That‚Äôs where the background jobs come into play, at the end of each
background job, we add one element back to the list using <code>LPUSH</code> and as soon
as an element is added the enqueuer which is blocked at <code>BLPOP</code> pops this
element and enqueues another job. This goes on till all your background jobs
are enqueued, all the while making sure that there are never more than 2 jobs
at any given time.</li>
</ol>
<p>Let‚Äôs put this into concrete ruby code.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ControlledConcurrency</span></span></span><br><span class="line">  <span class="comment"># I love module_function</span></span><br><span class="line">  module_function</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The name of our list needs to be constant per worker type, you could</span></span><br><span class="line">  <span class="comment"># probably extract this into a Sidekiq middleware with a little effort</span></span><br><span class="line">  LIST_NAME = <span class="string">&quot;migrate&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(<span class="symbol">concurrency:</span>)</span></span></span><br><span class="line">    <span class="comment"># if our list already has elements before we start, our concurrency will be</span></span><br><span class="line">    <span class="comment"># screwed, so, this is a safety check!</span></span><br><span class="line">    slot_count = Redis.current.llen(LIST_NAME)</span><br><span class="line">    raise <span class="string">&quot;Key &#x27;<span class="subst">#&#123;LIST_NAME&#125;</span>&#x27; is being used, it already has <span class="subst">#&#123;slot_count&#125;</span> slots&quot;</span> <span class="keyword">if</span> slot_count &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Seed our list with as many items as the concurrency, the contents of this</span></span><br><span class="line">    <span class="comment"># list don&#x27;t matter.</span></span><br><span class="line">    Redis.current.lpush(LIST_NAME, concurrency.times.to_a)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># A helper function to bump up concurrency if you need to</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">increase_concurrency</span><span class="params">(n = <span class="number">1</span>)</span></span></span><br><span class="line">    Redis.current.lpush(LIST_NAME, n.times.to_a)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># A helper function to bump the concurrency down if you need to</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">decrease_concurrency</span><span class="params">(n = <span class="number">1</span>)</span></span></span><br><span class="line">    n.times <span class="keyword">do</span></span><br><span class="line">      puts <span class="string">&quot;&gt; waiting&quot;</span></span><br><span class="line">      Redis.current.blpop(LIST_NAME)</span><br><span class="line">      puts <span class="string">&quot;&gt; decrease by 1&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># This is our core enqueuer, it runs in a loop because our blpop might get a</span></span><br><span class="line">  <span class="comment"># timeout and return nil, we keep trying till it returns a value</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">nq</span><span class="params">(&amp;block)</span></span></span><br><span class="line">    loop <span class="keyword">do</span></span><br><span class="line">      puts <span class="string">&quot;&gt; waiting to enqueue&quot;</span></span><br><span class="line">      slot = Redis.current.blpop(LIST_NAME)</span><br><span class="line">      <span class="keyword">if</span> slot</span><br><span class="line">        puts <span class="string">&quot;&gt; found slot <span class="subst">#&#123;slot&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Function which allow background workers to signal that a job has been</span></span><br><span class="line">  <span class="comment"># completed, so that the enqueuer can nq more jobs.</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">return_slot</span></span></span><br><span class="line">    puts <span class="string">&quot;&gt; returning slot&quot;</span></span><br><span class="line">    Redis.current.lpush(LIST_NAME, <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is our Sidekiq worker</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HardWorker</span></span></span><br><span class="line">  <span class="keyword">include</span> Sidekiq::Worker</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Our set up doesn&#x27;t enforce concurrency across retries, if you want this,</span></span><br><span class="line">  <span class="comment"># you&#x27;ll probably have to tweak the code a little more :)</span></span><br><span class="line">  sidekiq_options <span class="symbol">retry:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># the only custom code here is in the ensure block</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">perform</span><span class="params">(user_id)</span></span></span><br><span class="line">    puts <span class="string">&quot;&gt; start: <span class="subst">#&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># mock work</span></span><br><span class="line">    sleep <span class="number">1</span></span><br><span class="line">    puts <span class="string">&quot;&gt; finish: <span class="subst">#&#123;user_id&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">ensure</span></span><br><span class="line">    <span class="comment"># make sure that we return this slot at the end of the background job, so</span></span><br><span class="line">    <span class="comment"># that the next job can be enqueued. This doesn&#x27;t handle retries because of</span></span><br><span class="line">    <span class="comment"># failures, we disabled retries for our job, but if you have them enabled,</span></span><br><span class="line">    <span class="comment"># you might end up having more jobs than the set concurrency because of</span></span><br><span class="line">    <span class="comment"># retried jobs.</span></span><br><span class="line">    ControlledConcurrency.return_slot</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ./concurrency_setter.rb</span></span><br><span class="line">ControlledConcurrency.setup(<span class="symbol">concurrency:</span> ARGV.first.to_i)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ./enqueuer.rb</span></span><br><span class="line"><span class="comment"># Before running the enqueuer, we need to set up the concurrency using the above script</span></span><br><span class="line"><span class="comment"># This our enqueuer and it makes sure that the block passed to</span></span><br><span class="line"><span class="comment"># ControlledConcurrency.nq doesn&#x27;t enqueue more jobs that our concurrency</span></span><br><span class="line"><span class="comment"># setting.</span></span><br><span class="line"><span class="number">100</span>.times <span class="keyword">do</span> <span class="params">|i|</span></span><br><span class="line">  ControlledConcurrency.nq <span class="keyword">do</span></span><br><span class="line">    puts <span class="string">&quot;&gt; enqueuing user_id: <span class="subst">#&#123;i&#125;</span>&quot;</span></span><br><span class="line">    HardWorker.perform_async(i)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>That‚Äôs all folks! Hope you find this useful!</p>
<p>The full code for this can be found at: <a target="_blank" rel="noopener" href="https://github.com/minhajuddin/sidekiq-controlled-concurrency">https://github.com/minhajuddin/sidekiq-controlled-concurrency</a></p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/07/13/how-to-control-enqueuing-speed-of-sidekiq-jobs-and-their-execution-concurrency/" data-id="ckvg57nkg003acdol3atgau16" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/07/13/how-to-control-enqueuing-speed-of-sidekiq-jobs-and-their-execution-concurrency/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/backpressure/" rel="tag">Backpressure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrency/" rel="tag">Concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/enqueue/" rel="tag">Enqueue</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/" rel="tag">Redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/" rel="tag">Ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sidekiq/" rel="tag">Sidekiq</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-create-a-web-server-using-cowboy-without-plug" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/05/how-to-create-a-web-server-using-cowboy-without-plug/" class="article-date">
  <time datetime="2020-06-05T17:33:48.000Z" itemprop="datePublished">2020-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/05/how-to-create-a-web-server-using-cowboy-without-plug/">How to create a web server using Cowboy without Plug or Phoenix - Part 01</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Cowboy is an amazing web server that is used by Plug/Phoenix out of the box, I
don‚Äôt think Phoenix supports any other web servers at the moment. However, the
<a target="_blank" rel="noopener" href="https://github.com/elixir-plug/plug/blob/master/lib/plug/conn/adapter.ex">plug
adapter</a>
is fairly abstracted, and plug implements this adapter for cowboy through the
<a target="_blank" rel="noopener" href="https://github.com/elixir-plug/plug_cowboy/">plug_cowboy</a> hex package. In
theory, you should be able to write a new adapter if you just implement the <a target="_blank" rel="noopener" href="https://github.com/elixir-plug/plug/blob/master/lib/plug/conn/adapter.ex">Plug
adapter <abbr title="That's not a typo :) it comes from the british heritage of
Erlang">behaviour</abbr></a>.
The plug cowboy adapter has a lot of interesting code and you‚Äôll learn a lot
from reading it. Anyway, this blog post isn‚Äôt about Plug or Phoenix. I wanted to
show off how you can create a simple Cowboy server without using Plug or Phoenix
(I had to learn how to do this while creating my side project
<a target="_blank" rel="noopener" href="https://webpipe.hyperngn.com/">webpipe</a>)</p>
<p>We want an application which spins up a cowboy server and renders a hello world
message. Here is the required code for that:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Hello</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># The handler module which handles all requests, its `init` function is called</span></span><br><span class="line">  <span class="comment"># by Cowboy for all matching requests.</span></span><br><span class="line">  <span class="class"><span class="keyword">defmodule</span> <span class="title">Handler</span></span> <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init</span></span>(req, _opts) <span class="keyword">do</span></span><br><span class="line">      resp =</span><br><span class="line">        <span class="symbol">:cowboy_req</span>.reply(</span><br><span class="line">          _status = <span class="number">200</span>,</span><br><span class="line">          _headers = %&#123;<span class="string">&quot;content-type&quot;</span> =&gt; <span class="string">&quot;text/html; charset=utf-8&quot;</span>&#125;,</span><br><span class="line">          _body = <span class="string">&quot;&lt;!doctype html&gt;&lt;h1&gt;Hello, Cowboy!&lt;/h1&gt;&quot;</span>,</span><br><span class="line">          _request = req</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">      &#123;<span class="symbol">:ok</span>, resp, []&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span></span> <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># compile the routes</span></span><br><span class="line">    routes =</span><br><span class="line">      <span class="symbol">:cowboy_router</span>.compile([</span><br><span class="line">        &#123;<span class="symbol">:_</span>,</span><br><span class="line">         [</span><br><span class="line">           <span class="comment"># &#123; wildcard, handler module (needs to have an init function), options &#125;</span></span><br><span class="line">           &#123;<span class="symbol">:_</span>, Handler, []&#125;</span><br><span class="line">         ]&#125;</span><br><span class="line">      ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">require</span> Logger</span><br><span class="line">    Logger.info(<span class="string">&quot;Staring server at http://localhost:4001/&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># start an http server</span></span><br><span class="line">    <span class="symbol">:cowboy</span>.start_clear(</span><br><span class="line">      <span class="symbol">:hello_http</span>,</span><br><span class="line">      [<span class="symbol">port:</span> <span class="number">4001</span>],</span><br><span class="line">      %&#123;<span class="symbol">env:</span> %&#123;<span class="symbol">dispatch:</span> routes&#125;&#125;</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>And, here is a quick test to assert that it works!</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">HelloTest</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> ExUnit.Case</span><br><span class="line"></span><br><span class="line">  test <span class="string">&quot;returns hello world&quot;</span> <span class="keyword">do</span></span><br><span class="line">    assert &#123;<span class="symbol">:ok</span>, &#123;&#123;<span class="string">&#x27;HTTP/1.1&#x27;</span>, <span class="number">200</span>, <span class="string">&#x27;OK&#x27;</span>&#125;, _headers, <span class="string">&#x27;&lt;!doctype html&gt;&lt;h1&gt;Hello, Cowboy!&lt;/h1&gt;&#x27;</span>&#125;&#125; =</span><br><span class="line">             <span class="symbol">:httpc</span>.request(<span class="string">&#x27;http://localhost:4001/&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/hyperngn/cowboy-examples/tree/master/hello">Full code on GitHub</a></p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/06/05/how-to-create-a-web-server-using-cowboy-without-plug/" data-id="ckvg57nkk003hcdolfuwrea1h" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/06/05/how-to-create-a-web-server-using-cowboy-without-plug/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cowboy/" rel="tag">Cowboy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/phoenix/" rel="tag">Phoenix</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/plug/" rel="tag">Plug</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpipe/" rel="tag">Webpipe</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-my-first-svg-creation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/17/my-first-svg-creation/" class="article-date">
  <time datetime="2020-05-17T17:51:15.000Z" itemprop="datePublished">2020-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/17/my-first-svg-creation/">My first SVG creation</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>SVG is amazing, I want to design the logo of my next company using it!</p>
<svg style='border: solid 1px #0f0' viewbox='0 0 200 200' stroke="#44337a" fill='#6b46c1'>
      <circle cx=100 cy=100 r=80 fill=none />

      <circle cx=60 cy=60 r=10 fill=none stroke=black />
      <circle cx=60 cy=60 r=6 fill=#0074D9 stroke=none />

      <circle cx=140 cy=60 r=10 fill=none stroke=black />
      <circle cx=140 cy=60 r=6 fill=#0074D9 stroke=none />



      <path d="
               M 90,140
               A 8 5 0 1 0 110,140
               z
               " fill=none />

      <circle cx=100 cy=100 r=20 fill=#FF4136 stroke=none />


    </svg>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg style=&#x27;border: solid 1px #0f0&#x27; viewbox=&#x27;0 0 200 200&#x27; stroke=&quot;#44337a&quot; fill=&#x27;#6b46c1&#x27;&gt;</span><br><span class="line">      &lt;circle cx=100 cy=100 r=80 fill=none /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;circle cx=60 cy=60 r=10 fill=none stroke=black /&gt;</span><br><span class="line">      &lt;circle cx=60 cy=60 r=6 fill=#0074D9 stroke=none /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;circle cx=140 cy=60 r=10 fill=none stroke=black /&gt;</span><br><span class="line">      &lt;circle cx=140 cy=60 r=6 fill=#0074D9 stroke=none /&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &lt;path d=&quot;</span><br><span class="line">               M 90,140</span><br><span class="line">               A 8 5 0 1 0 110,140</span><br><span class="line">               z</span><br><span class="line">               &quot; fill=none /&gt;</span><br><span class="line"></span><br><span class="line">      &lt;circle cx=100 cy=100 r=20 fill=#FF4136 stroke=none /&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;/svg&gt;</span><br></pre></td></tr></table></figure>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/05/17/my-first-svg-creation/" data-id="ckvg57nm4006wcdolh28a3q6j" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/05/17/my-first-svg-creation/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-many-to-many-relationships-in-ecto-and-phoenix-screencast-part-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/17/many-to-many-relationships-in-ecto-and-phoenix-screencast-part-2/" class="article-date">
  <time datetime="2020-05-17T00:00:00.000Z" itemprop="datePublished">2020-05-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/17/many-to-many-relationships-in-ecto-and-phoenix-screencast-part-2/">many_to_many relationships in Ecto and Phoenix - Screencast - Part 2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="video-container"><iframe src="https://www.youtube.com/embed/_ut8o0fdXRo" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/05/17/many-to-many-relationships-in-ecto-and-phoenix-screencast-part-2/" data-id="ckvg57nlz006lcdold1erbzdk" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/05/17/many-to-many-relationships-in-ecto-and-phoenix-screencast-part-2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ecto/" rel="tag">Ecto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/phoenix/" rel="tag">Phoenix</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tags/" rel="tag">Tags</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/many-to-many/" rel="tag">many_to_many</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/relationships/" rel="tag">relationships</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-many-to-many-relationships-in-ecto-and-phoenix-screencast-part-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/11/many-to-many-relationships-in-ecto-and-phoenix-screencast-part-1/" class="article-date">
  <time datetime="2020-05-11T11:18:05.000Z" itemprop="datePublished">2020-05-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/11/many-to-many-relationships-in-ecto-and-phoenix-screencast-part-1/">many_to_many relationships in Ecto and Phoenix - Screencast - Part 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <div class="video-container"><iframe src="https://www.youtube.com/embed/Cl2U_8XtUBM" frameborder="0" loading="lazy" allowfullscreen></iframe></div>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/05/11/many-to-many-relationships-in-ecto-and-phoenix-screencast-part-1/" data-id="ckvg57nly006icdol0v2g15zj" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/05/11/many-to-many-relationships-in-ecto-and-phoenix-screencast-part-1/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ecto/" rel="tag">Ecto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/phoenix/" rel="tag">Phoenix</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tags/" rel="tag">Tags</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/many-to-many/" rel="tag">many_to_many</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/relationships/" rel="tag">relationships</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-use-a-single-aurora-cluster-for-multiple-databases-each-with-its-own-restricted-user" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/09/how-to-use-a-single-aurora-cluster-for-multiple-databases-each-with-its-own-restricted-user/" class="article-date">
  <time datetime="2020-05-09T15:58:55.000Z" itemprop="datePublished">2020-05-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/09/how-to-use-a-single-aurora-cluster-for-multiple-databases-each-with-its-own-restricted-user/">How to use a single aurora cluster for multiple databases each with its own restricted user</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I have been playing around with terraform for the last few days and it is an
amazing tool to manage infrastructure. For my AWS infrastructure I needed an
aurora postgresql cluster which would allow hosting of multiple databases, each
for one of my side projects, while also keeping them isolated and preventing
an app user from accessing other app‚Äôs databases.</p>
<img src="/2020/05/09/how-to-use-a-single-aurora-cluster-for-multiple-databases-each-with-its-own-restricted-user/db.png" class="">
<p><a target="_blank" rel="noopener" href="https://www.terraform.io/docs/providers/postgresql/index.html">Terraform has an awesome postgresql
provider</a> which
can be used for managing databases, However there are a few parts which are
tricky and needed trial and error to get right.</p>
<h2 id="Connecting-to-an-RDS-database-via-an-SSH-tunnel"><a href="#Connecting-to-an-RDS-database-via-an-SSH-tunnel" class="headerlink" title="Connecting to an RDS database via an SSH tunnel"></a>Connecting to an RDS database via an SSH tunnel</h2><p>The first roadblock was that my RDS cluster wasn‚Äôt accessible publicly (which is
how it should be for security reasons). I do have a <a href="https://minhajuddin.com/2020/05/06/how-to-create-temporary-bastion-ec2-instances-using-terraform/">way to connect to my
postgres servers via a bastion
host</a>.
I thought we could use an SSH tunnel over the bastion host to get to our RDS
cluster from my local computer. However, terraform doesn‚Äôt support
connecting to the postgres server over an SSH tunnel via its configuration.</p>
<p>So, it required a little bit of jerry-rigging. The postgresql provider was happy
as long as it could reach the postgres cluster using a host, port and password.
So, I set up a local tunnel outside terraform via my SSH config like so:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Host bastion</span><br><span class="line">Hostname ec2-180-21-145-48.us-east-2.compute.amazonaws.com</span><br><span class="line">IdentityFile ~/.ssh/aws_ssh.pem</span><br><span class="line"></span><br><span class="line">Host ecs1-pg</span><br><span class="line">  LocalForward localhost:3333 hn-aurora-pg-1.hosturl.us-east-2.rds.amazonaws.com:5432</span><br><span class="line"></span><br><span class="line">Host ecs1 ecs1-pg</span><br><span class="line">  Hostname 20.10.22.214</span><br><span class="line">  User ec2-user</span><br><span class="line">  IdentityFile ~/.ssh/aws_ssh.pem</span><br><span class="line">  ForwardAgent yes</span><br><span class="line">  ProxyJump bastion</span><br></pre></td></tr></table></figure>
<p>The relevant line here is the <code>LocalForward</code> declaration which wires up a local
port forward so that when you network traffic hits port <code>3333</code> on your
<code>localhost</code> it is tunneled over the bastion and then the ecs server and is
routed to your cluster‚Äôs port <code>5432</code>. One thing to note here is that your ecs
cluster should be able to connect to your RDS cluster via proper security group
rules.</p>
<h2 id="Setting-up-the-postgres-provider"><a href="#Setting-up-the-postgres-provider" class="headerlink" title="Setting up the postgres provider"></a>Setting up the postgres provider</h2><p>Once you have the ssh tunnel set up, you can start wiring up your postgres
provider for terraform like so:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">provider &quot;postgresql&quot; &#123;</span><br><span class="line">  version = &quot;~&gt; 1.5&quot;</span><br><span class="line"></span><br><span class="line">  # LocalForwarded on the local computer via an SSH tunnel to</span><br><span class="line">  # module.hn_db.this_rds_cluster_endpoint</span><br><span class="line">  # via</span><br><span class="line">  # LocalForward localhost:3333 module.hn_db.this_rds_cluster_endpoint:5432</span><br><span class="line">  host            = &quot;localhost&quot;</span><br><span class="line">  port            = 3333</span><br><span class="line">  username        = &quot;root&quot;</span><br><span class="line">  superuser       = false</span><br><span class="line">  password        = module.hn_db.this_rds_cluster_master_password</span><br><span class="line">  sslmode         = &quot;require&quot;</span><br><span class="line">  connect_timeout = 15</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The provider config is pretty straightforward, we point it to <code>localhost:3333</code>
with a <code>root</code> user (which is the master user created by the rds cluster). So,
when you connect to <code>localhost:3333</code>, you are actually connecting to the RDS
cluster through an SSH tunnel (make sure that your ssh connection is open at
this point via <code>ssh ecs1-pg</code> in a separate terminal). We also need to set the
<code>superuser</code> to <code>false</code> because RDS doesn‚Äôt give us a postgres superuser, getting
this wrong initially caused me a lot of frustration.</p>
<h2 id="Setting-up-the-database-and-it‚Äôs-user"><a href="#Setting-up-the-database-and-it‚Äôs-user" class="headerlink" title="Setting up the database and it‚Äôs user"></a>Setting up the database and it‚Äôs user</h2><p>Now that our cluster connectivity is set up, we can start creating the databases
and users, each for one of our apps.</p>
<p>Below is a sensible configuration for a database called <code>liveform_prod</code> and it‚Äôs
user called <code>liveform</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">locals &#123;</span><br><span class="line">  lf_connection_limit  = 5</span><br><span class="line">  lf_statement_timeout = 60000 # 1 minute</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;postgresql_database&quot; &quot;liveform_db&quot; &#123;</span><br><span class="line">  name             = &quot;liveform_prod&quot;</span><br><span class="line">  owner            = postgresql_role.liveform_db_role.name</span><br><span class="line">  connection_limit = local.lf_connection_limit</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;postgresql_role&quot; &quot;liveform_db_role&quot; &#123;</span><br><span class="line">  name              = &quot;liveform&quot;</span><br><span class="line">  login             = true</span><br><span class="line">  password          = random_password.liveform_db_password.result</span><br><span class="line">  connection_limit  = local.lf_connection_limit</span><br><span class="line">  statement_timeout = local.lf_statement_timeout</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;random_password&quot; &quot;liveform_db_password&quot; &#123;</span><br><span class="line">  length  = 40</span><br><span class="line">  special = false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;liveform_db_password&quot; &#123;</span><br><span class="line">  description = &quot;Liveform db password&quot;</span><br><span class="line">  value       = random_password.liveform_db_password.result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A few things to note here:</p>
<ol>
<li>The database <code>liveform_prod</code> is owned by a new user called <code>liveform</code>.</li>
<li>It has a connection limit of <code>5</code>, You should always set a sensible
connection limit to prevent this app from crashing the cluster.</li>
<li>The db user too has a connection limit of <code>5</code> and a statement timeout of 1
minute which is big enough for web apps, you should set it to the least
duration which works for your app.</li>
<li>A random password (via the <code>random_password</code> resource) is used as the
password of our new <code>liveform</code> role. This can be viewed by running
<code>terraform show</code></li>
</ol>
<h2 id="Isolating-this-database-from-other-users"><a href="#Isolating-this-database-from-other-users" class="headerlink" title="Isolating this database from other users"></a>Isolating this database from other users</h2><p>By default postgres allows all users to connect to all databases and create/view
from all the tables. We want our databases to be isolated properly so that a
user for one app cannot access another app‚Äôs database. This requires running of
some SQL on the newly created database. We can easily do this using a
<code>null_resource</code> and a <code>local-exec</code> provisioner like so:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;null_resource&quot; &quot;liveform_db_after_create&quot; &#123;</span><br><span class="line">  depends_on = [</span><br><span class="line">    postgresql_database.liveform_db,</span><br><span class="line">    postgresql_role.liveform_db_role</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  provisioner &quot;local-exec&quot; &#123;</span><br><span class="line">    command = &quot;./pg_database_roles_setup.sh&quot;</span><br><span class="line">    environment = &#123;</span><br><span class="line">      PG_DB_ROLE_NAME = postgresql_role.liveform_db_role.name</span><br><span class="line">      PG_DB_NAME      = postgresql_database.liveform_db.name</span><br><span class="line">      PGPASSWORD      = random_password.liveform_db_password.result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>./pg_database_roles_setup.sh</code> script:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># This needs an SSH TUNNEL to be set up</span></span><br><span class="line"><span class="comment"># password needs to be supplied via the PGPASSWORD env var</span></span><br><span class="line">psql --host <span class="string">&quot;localhost&quot;</span> \</span><br><span class="line">    --port <span class="string">&quot;3333&quot;</span> \</span><br><span class="line">    --username <span class="string">&quot;<span class="variable">$PG_DB_ROLE_NAME</span>&quot;</span> \</span><br><span class="line">    --dbname <span class="string">&quot;<span class="variable">$PG_DB_NAME</span>&quot;</span> \</span><br><span class="line">    --file - &lt;&lt;<span class="string">SQL</span></span><br><span class="line"><span class="string">  REVOKE CONNECT ON DATABASE $PG_DB_NAME FROM PUBLIC;</span></span><br><span class="line"><span class="string">  GRANT CONNECT ON DATABASE $PG_DB_NAME TO $PG_DB_ROLE_NAME;</span></span><br><span class="line"><span class="string">  GRANT CONNECT ON DATABASE $PG_DB_NAME TO root;</span></span><br><span class="line"><span class="string">SQL</span></span><br></pre></td></tr></table></figure>
<p>The <code>pg_database_roles_setup.sh</code> script connects to our rds cluster over the SSH
tunnel to the newly created database as the newly created user and revokes
connect privileges for all users on this database, and then adds connect
privileges to the app user and the root user. You can add more queries to this
script that you might want to run after the database is set up. Finally, the
<code>local-exec</code> provisioner passes the right data via environment variables and
calls the database setup script.</p>
<h2 id="Gotchas"><a href="#Gotchas" class="headerlink" title="Gotchas"></a>Gotchas</h2><p>If you create a <code>posgresql_role</code> before setting the connection‚Äôs <code>superuser</code> to
<code>false</code>, you‚Äôll get stuck trying to update or delete the new role. To work around
this, manually log in to the rds cluster via psql and <code>DROP</code> the role, and remove
this state from terraform using: <code>terraform state rm
postgresql_role.liveform_db_role</code></p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/05/09/how-to-use-a-single-aurora-cluster-for-multiple-databases-each-with-its-own-restricted-user/" data-id="ckvg57nlh005dcdol5o2z2tz3" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/05/09/how-to-use-a-single-aurora-cluster-for-multiple-databases-each-with-its-own-restricted-user/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/" rel="tag">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aurora/" rel="tag">Aurora</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/isolated/" rel="tag">Isolated</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/multiple/" rel="tag">Multiple</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgres/" rel="tag">Postgres</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgres-provider/" rel="tag">Postgres provider</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rds/" rel="tag">RDS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/restricted/" rel="tag">Restricted</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/terraform/" rel="tag">Terraform</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/user/" rel="tag">User</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-create-temporary-bastion-ec2-instances-using-terraform" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/06/how-to-create-temporary-bastion-ec2-instances-using-terraform/" class="article-date">
  <time datetime="2020-05-06T12:02:47.000Z" itemprop="datePublished">2020-05-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/06/how-to-create-temporary-bastion-ec2-instances-using-terraform/">How to create temporary bastion EC2 instances using Terraform</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I have recently started learning Terraform to manage my AWS resources, And it is
a great tool for maintaining your infrastructure! I use a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bastion_host">Bastion
host</a> to SSH into my main servers
and bring up the bastion host on demand only when I need it giving me some cost
savings. Here are the required Terraform files to get this working.</p>
<p>Set up the <code>bastion.tf</code> file like so:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"># get a reference to aws_ami.id using a data resource by finding the right AMI</span><br><span class="line">data &quot;aws_ami&quot; &quot;ubuntu&quot; &#123;</span><br><span class="line">  # pick the most recent version of the AMI</span><br><span class="line">  most_recent = true</span><br><span class="line"></span><br><span class="line">  # Find the 20.04 image</span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;name&quot;</span><br><span class="line">    values = [&quot;ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # With the right virtualization type</span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;virtualization-type&quot;</span><br><span class="line">    values = [&quot;hvm&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # And the image should be published by Canonical (which is a trusted source)</span><br><span class="line">  owners = [&quot;099720109477&quot;] # Canonical&#x27;s owner_id don&#x27;t change this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Configuration for your bastion EC2 instance</span><br><span class="line">resource &quot;aws_instance&quot; &quot;bastion&quot; &#123;</span><br><span class="line">  # Use the AMI from the above step</span><br><span class="line">  ami = data.aws_ami.ubuntu.id</span><br><span class="line"></span><br><span class="line">  # We don&#x27;t need a heavy duty server, t2.micro should suffice</span><br><span class="line">  instance_type = &quot;t2.micro&quot;</span><br><span class="line"></span><br><span class="line">  # We use a variable which can be set to true or false in the terraform.tfvars</span><br><span class="line">  # file to control creating or destroying the bastion resource on demand.</span><br><span class="line">  count = var.bastion_enabled ? 1 : 0</span><br><span class="line"></span><br><span class="line">  # The ssh key name</span><br><span class="line">  key_name = var.ssh_key_name</span><br><span class="line"></span><br><span class="line">  # This should refer to the subnet in which you want to spin up the Bastion host</span><br><span class="line">  # You can even hardcode this ID by getting a subnet id from the AWS console</span><br><span class="line">  subnet_id = aws_subnet.subnet[0].id</span><br><span class="line"></span><br><span class="line">  # The 2 security groups here have 2 important rules</span><br><span class="line">  # 1. hn_bastion_sg: opens up Port 22 for just my IP address</span><br><span class="line">  # 2. default: sets up an open network within the security group</span><br><span class="line">  vpc_security_group_ids = [aws_security_group.hn_bastion_sg.id, aws_default_security_group.default.id]</span><br><span class="line"></span><br><span class="line">  # Since we want to access this via internet, we need a public IP</span><br><span class="line">  associate_public_ip_address = true</span><br><span class="line"></span><br><span class="line">  # Some useful tags</span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;Bastion&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># We want to output the public_dns name of the bastion host when it spins up</span><br><span class="line">output &quot;bastion-public-dns&quot; &#123;</span><br><span class="line">  value = var.bastion_enabled ? aws_instance.bastion[0].public_dns : &quot;No-bastion&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Set up the <code>terraform.tfvars</code> file like so:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Set this to `true` and do a `terraform apply` to spin up a bastion host</span><br><span class="line"># and when you are done, set it to `false` and do another `terraform apply`</span><br><span class="line">bastion_enabled = false</span><br><span class="line"></span><br><span class="line"># My SSH keyname (without the .pem extension)</span><br><span class="line">ssh_key_name = &quot;hyperngn_aws_ohio&quot;</span><br><span class="line"></span><br><span class="line"># The IP of my computer. Do a `curl -sq icanhazip.com` to get it</span><br><span class="line"># Look for the **ProTip** down below to automate this!</span><br><span class="line">myip = [&quot;247.39.103.23/32&quot;]</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>Set up the <code>vars.tf</code> file like so:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;ssh_key_name&quot; &#123;</span><br><span class="line">  description = &quot;Name of AWS key pair&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;myip&quot; &#123;</span><br><span class="line">  type        = list(string)</span><br><span class="line">  description = &quot;My IP to allow SSH access into the bastion server&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;bastion_enabled&quot; &#123;</span><br><span class="line">  description = &quot;Spins up a bastion host if enabled&quot;</span><br><span class="line">  type        = bool</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Relevant sections from my <code>vpc.tf</code>, you could just hardcode these values in the
<code>bastion.tf</code> or use <code>data</code> if you‚Äôve set these up manually and <code>resources</code> if
you use terraform to control them</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_subnet&quot; &quot;subnet&quot; &#123;</span><br><span class="line">  # ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Allows SSH connections from our IP</span><br><span class="line">resource &quot;aws_security_group&quot; &quot;hn_bastion_sg&quot; &#123;</span><br><span class="line">  name   = &quot;hn_bastion_sg&quot;</span><br><span class="line">  vpc_id = aws_vpc.vpc.id</span><br><span class="line"></span><br><span class="line">  ingress &#123;</span><br><span class="line">    from_port   = 22</span><br><span class="line">    to_port     = 22</span><br><span class="line">    protocol    = &quot;tcp&quot;</span><br><span class="line">    cidr_blocks = var.myip</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  egress &#123;</span><br><span class="line">    from_port   = 0</span><br><span class="line">    to_port     = 0</span><br><span class="line">    protocol    = &quot;-1&quot;</span><br><span class="line">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Allow inter security group connections</span><br><span class="line">resource &quot;aws_default_security_group&quot; &quot;default&quot; &#123;</span><br><span class="line">  vpc_id = aws_vpc.vpc.id</span><br><span class="line"></span><br><span class="line">  ingress &#123;</span><br><span class="line">    protocol  = -1</span><br><span class="line">    self      = true</span><br><span class="line">    from_port = 0</span><br><span class="line">    to_port   = 0</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  egress &#123;</span><br><span class="line">    from_port   = 0</span><br><span class="line">    to_port     = 0</span><br><span class="line">    protocol    = &quot;-1&quot;</span><br><span class="line">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally you need to set up your ~/.ssh/config to use the bastion as the jump
host like so:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># Bastion config</span><br><span class="line">Host bastion</span><br><span class="line"># Change the hostname to whatever you get from terraform&#x27;s output</span><br><span class="line">Hostname ec2-5-55-128-160.us-east-2.compute.amazonaws.com</span><br><span class="line">IdentityFile ~/.ssh/hyperngn_aws_ohio.pem</span><br><span class="line"></span><br><span class="line"># ECS cluster machines</span><br><span class="line">Host ecs1</span><br><span class="line">Hostname 20.10.21.217</span><br><span class="line">User ec2-user</span><br><span class="line">IdentityFile ~/.ssh/hyperngn_aws_ohio.pem</span><br><span class="line">ForwardAgent yes</span><br><span class="line">ProxyJump bastion</span><br><span class="line"></span><br><span class="line"># This section is optional but allows you to reuse SSH connections</span><br><span class="line">Host *</span><br><span class="line">  User ubuntu</span><br><span class="line">   Compression yes</span><br><span class="line"># every 10 minutes send an alive ping</span><br><span class="line">   ServerAliveInterval 60</span><br><span class="line">   ControlMaster auto</span><br><span class="line">   ControlPath /tmp/ssh-%r@%h:%p</span><br></pre></td></tr></table></figure>
<p>Once you are done, you can just login by running the following command and it
should run seamlessly:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh ecs1</span><br></pre></td></tr></table></figure>
<p><strong>Pro-Tip</strong> Put the following in your terraform folder‚Äôs .envrc, so that you
don‚Äôt have to manually copy paste your IP every time you bring your bastion host
up (You also need to have <a target="_blank" rel="noopener" href="https://direnv.net/">direnv</a> for this to work).
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat .envrc</span><br><span class="line">export TF_VAR_myip=&quot;[\&quot;$(curl -sq icanhazip.com)/32\&quot;]&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="Gotchas"><a href="#Gotchas" class="headerlink" title="Gotchas"></a>Gotchas</h2><ol>
<li>If you run into any issues use the <code>ssh -vv ecs1</code> command to get copious
logs and read through all of them to figure out what might be wrong.</li>
<li>Make sure you are using the correct <code>User</code>, Ubuntu AMIs create a user called
<code>ubuntu</code> whereas Amazon ECS optimized AMIs create an <code>ec2-user</code> user, If you
get the user wrong <code>ssh</code> will fail.</li>
<li>Use private IPs for the target servers that you are jumping into and the
public IP or public DNS for your bastion host.</li>
<li>Make sure your Bastion host is in the same VPC with a default security group
which allows inter security group communication and a security group which
opens up the SSH port for your IP. If they are not on the same VPC make sure
they have the right security groups to allow communication from the bastion
host to the target host, specifically on port 22. You can use VPC flow logs
to figure problems in your network.</li>
</ol>
<p>From a security point of view this is a pretty great set up, your normal servers
don‚Äôt allow any SSH access (and in my case aren‚Äôt even public and are fronted by
ALBs). And your bastion host is not up all the time, and even when it is up, it
only allows traffic from your single IP. It also saves cost by tearing down the
bastion instance when you don‚Äôt need it.</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/05/06/how-to-create-temporary-bastion-ec2-instances-using-terraform/" data-id="ckvg57nkl003kcdol4ij6aik6" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/05/06/how-to-create-temporary-bastion-ec2-instances-using-terraform/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aws/" rel="tag">AWS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bastion/" rel="tag">Bastion</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ec2/" rel="tag">EC2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/proxyjump/" rel="tag">ProxyJump</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh/" rel="tag">SSH</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/terraform/" rel="tag">Terraform</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-many-to-many-relationships-in-ecto-and-phoenix-for-products-and-tags" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/03/many-to-many-relationships-in-ecto-and-phoenix-for-products-and-tags/" class="article-date">
  <time datetime="2020-05-03T12:54:34.000Z" itemprop="datePublished">2020-05-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/03/many-to-many-relationships-in-ecto-and-phoenix-for-products-and-tags/">many_to_many relationships in Ecto and Phoenix for Products and Tags</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The other day I was helping a friend set up a phoenix app which required the use
of tags on products, we all have used tags in our day to day to add information
about notes, images, and other stuff. Tags are just labels/chunks-of-text which
are used to associated with an entity like a product, blog post, image, etc.
This blog post has a few tags too (Ecto, Elixir, Phoenix, etc.). Tags help us
organize information by annotating records with useful fragments of
information. And modeling these in a database is pretty straightforward, it is
usually implemented like the following design.</p>
<img src="/2020/05/03/many-to-many-relationships-in-ecto-and-phoenix-for-products-and-tags/erd-small.jpg" class="" title="Products and Tags ERD">
<p>As you can see, we have a many-to-many relation between the products and tags
tables via a products_tags table which has just 2 columns the <code>product_id</code> and
the <code>tag_id</code> and it has a composite primary key (while also having an index on
the <code>tag_id</code> to make lookups faster). The use of a join table is required,
however, you usually want the join table to be invisible in your domain, as you
don‚Äôt want to deal with a ProductTag model, it doesn‚Äôt serve any purpose other
than helping you bridge the object model with the relational model. Anyway, here
is how we ended up building the many-to-many relationship in Phoenix and Ecto.</p>
<h2 id="Scaffolding-the-models"><a href="#Scaffolding-the-models" class="headerlink" title="Scaffolding the models"></a>Scaffolding the models</h2><p>We use a nondescript <code>Core</code> context for our <code>Product</code> model by running the
following scaffold code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix phx.gen.html Core Product products name:string description:text</span><br></pre></td></tr></table></figure>
<p>This generates the following migration (I‚Äôve omitted the boilerplate to make
reading the relevant code easier):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table(:products) do</span><br><span class="line">  add :name, :string</span><br><span class="line">  add :description, :text</span><br><span class="line"></span><br><span class="line">  timestamps()</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>Don‚Äôt forget to add the following to your <code>router.ex</code></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resources <span class="string">&quot;/products&quot;</span>, ProductController</span><br></pre></td></tr></table></figure>
<p>Then, we add the <code>Tag</code> in the same context by running the following scaffold
generator:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix phx.gen.html Core Tag tags name:string:unique</span><br></pre></td></tr></table></figure>
<p>This generates the following migration, note the unique index on <code>name</code>, as we
don‚Äôt want tags with duplicate names, you might have separate tags per user in
which case you would have a unique index on <code>[:user_id, :name]</code>.</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table(<span class="symbol">:tags</span>) <span class="keyword">do</span></span><br><span class="line">  add <span class="symbol">:name</span>, <span class="symbol">:string</span></span><br><span class="line"></span><br><span class="line">  timestamps()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">create unique_index(<span class="symbol">:tags</span>, [<span class="symbol">:name</span>])</span><br></pre></td></tr></table></figure>
<p>Finally, we generate the migration for the join table <code>products_tags</code>(by
convention it uses the pluralized names of both entities joined by an underscore
so <code>products</code> and <code>tags</code> joined by an <code>_</code> gives us the name <code>products_tags</code>).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mix phx.gen.schema Core.ProductTag products_tags product_id:references:products tag_id:references:tags</span><br></pre></td></tr></table></figure>
<p>This scaffolded migration requires a few tweaks to make it look like the
following:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table(<span class="symbol">:products_tags</span>, <span class="symbol">primary_key:</span> <span class="keyword">false</span>) <span class="keyword">do</span></span><br><span class="line">  add <span class="symbol">:product_id</span>, references(<span class="symbol">:products</span>, <span class="symbol">on_delete:</span> <span class="symbol">:nothing</span>), <span class="symbol">primary_key:</span> <span class="keyword">true</span></span><br><span class="line">  add <span class="symbol">:tag_id</span>, references(<span class="symbol">:tags</span>, <span class="symbol">on_delete:</span> <span class="symbol">:nothing</span>), <span class="symbol">primary_key:</span> <span class="keyword">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">create index(<span class="symbol">:products_tags</span>, [<span class="symbol">:product_id</span>])</span><br><span class="line">create index(<span class="symbol">:products_tags</span>, [<span class="symbol">:tag_id</span>])</span><br></pre></td></tr></table></figure>
<p>Note the following:</p>
<ol>
<li>We added a <code>primary_key: false</code> declaration to the <code>table()</code> function call
to avoid creating a wasted <code>id</code> column.</li>
<li>We got rid of the <code>timestamps()</code> declaration as we don‚Äôt want to track
<code>inserts</code> and <code>updates</code> on the joins. You might want to track inserts if
you want to know when a product was tagged with a specific tag which makes
things a little more complex, so, we‚Äôll avoid it for now.</li>
<li>We added a <code>, primary_key: true</code> to the <code>:product_id</code> and <code>:tag_id</code> lines
to make <code>[:product_id, :tag_id]</code> a composite primary key</li>
</ol>
<p>Now our database is set up nicely for our many-to-many relationship. Here is how
our tables look in the database:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">product_tags_demo_dev=# \d products</span><br><span class="line">                                       Table &quot;public.products&quot;</span><br><span class="line">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span><br><span class="line">‚îÇ   Column    ‚îÇ              Type              ‚îÇ Collation ‚îÇ Nullable ‚îÇ           Default           ‚îÇ</span><br><span class="line">‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§</span><br><span class="line">‚îÇ id          ‚îÇ bigint                         ‚îÇ           ‚îÇ not null ‚îÇ nextval(&#x27;products_id_seq&#x27;::‚Ä¶‚îÇ</span><br><span class="line">‚îÇ             ‚îÇ                                ‚îÇ           ‚îÇ          ‚îÇ‚Ä¶regclass)                   ‚îÇ</span><br><span class="line">‚îÇ name        ‚îÇ character varying(255)         ‚îÇ           ‚îÇ          ‚îÇ                             ‚îÇ</span><br><span class="line">‚îÇ description ‚îÇ text                           ‚îÇ           ‚îÇ          ‚îÇ                             ‚îÇ</span><br><span class="line">‚îÇ inserted_at ‚îÇ timestamp(0) without time zone ‚îÇ           ‚îÇ not null ‚îÇ                             ‚îÇ</span><br><span class="line">‚îÇ updated_at  ‚îÇ timestamp(0) without time zone ‚îÇ           ‚îÇ not null ‚îÇ                             ‚îÇ</span><br><span class="line">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span><br><span class="line">Indexes:</span><br><span class="line">    &quot;products_pkey&quot; PRIMARY KEY, btree (id)</span><br><span class="line">Referenced by:</span><br><span class="line">    TABLE &quot;products_tags&quot; CONSTRAINT &quot;products_tags_product_id_fkey&quot; FOREIGN KEY (product_id) REFERENCES products(id)</span><br><span class="line"></span><br><span class="line">product_tags_demo_dev=# \d tags</span><br><span class="line">                                         Table &quot;public.tags&quot;</span><br><span class="line">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span><br><span class="line">‚îÇ   Column    ‚îÇ              Type              ‚îÇ Collation ‚îÇ Nullable ‚îÇ           Default           ‚îÇ</span><br><span class="line">‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§</span><br><span class="line">‚îÇ id          ‚îÇ bigint                         ‚îÇ           ‚îÇ not null ‚îÇ nextval(&#x27;tags_id_seq&#x27;::regc‚Ä¶‚îÇ</span><br><span class="line">‚îÇ             ‚îÇ                                ‚îÇ           ‚îÇ          ‚îÇ‚Ä¶lass)                       ‚îÇ</span><br><span class="line">‚îÇ name        ‚îÇ character varying(255)         ‚îÇ           ‚îÇ          ‚îÇ                             ‚îÇ</span><br><span class="line">‚îÇ inserted_at ‚îÇ timestamp(0) without time zone ‚îÇ           ‚îÇ not null ‚îÇ                             ‚îÇ</span><br><span class="line">‚îÇ updated_at  ‚îÇ timestamp(0) without time zone ‚îÇ           ‚îÇ not null ‚îÇ                             ‚îÇ</span><br><span class="line">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span><br><span class="line">Indexes:</span><br><span class="line">    &quot;tags_pkey&quot; PRIMARY KEY, btree (id)</span><br><span class="line">    &quot;tags_name_index&quot; UNIQUE, btree (name)</span><br><span class="line">Referenced by:</span><br><span class="line">    TABLE &quot;products_tags&quot; CONSTRAINT &quot;products_tags_tag_id_fkey&quot; FOREIGN KEY (tag_id) REFERENCES tags(id)</span><br><span class="line"></span><br><span class="line">product_tags_demo_dev=# \d products_tags</span><br><span class="line">              Table &quot;public.products_tags&quot;</span><br><span class="line">‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê</span><br><span class="line">‚îÇ   Column   ‚îÇ  Type  ‚îÇ Collation ‚îÇ Nullable ‚îÇ Default ‚îÇ</span><br><span class="line">‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§</span><br><span class="line">‚îÇ product_id ‚îÇ bigint ‚îÇ           ‚îÇ not null ‚îÇ         ‚îÇ</span><br><span class="line">‚îÇ tag_id     ‚îÇ bigint ‚îÇ           ‚îÇ not null ‚îÇ         ‚îÇ</span><br><span class="line">‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò</span><br><span class="line">Indexes:</span><br><span class="line">    &quot;products_tags_pkey&quot; PRIMARY KEY, btree (product_id, tag_id)</span><br><span class="line">    &quot;products_tags_product_id_index&quot; btree (product_id)</span><br><span class="line">    &quot;products_tags_tag_id_index&quot; btree (tag_id)</span><br><span class="line">Foreign-key constraints:</span><br><span class="line">    &quot;products_tags_product_id_fkey&quot; FOREIGN KEY (product_id) REFERENCES products(id)</span><br><span class="line">    &quot;products_tags_tag_id_fkey&quot; FOREIGN KEY (tag_id) REFERENCES tags(id)</span><br></pre></td></tr></table></figure>
<h2 id="Getting-tags-to-work"><a href="#Getting-tags-to-work" class="headerlink" title="Getting tags to work!"></a>Getting tags to work!</h2><p>Now comes the fun part, modifying our controllers and contexts to get our tags
working!</p>
<p>The first thing we need to do is add a many_to_many relationship on the <code>Product</code> schema like so:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">schema <span class="string">&quot;products&quot;</span> <span class="keyword">do</span></span><br><span class="line">  field <span class="symbol">:description</span>, <span class="symbol">:string</span></span><br><span class="line">  field <span class="symbol">:name</span>, <span class="symbol">:string</span></span><br><span class="line">  many_to_many <span class="symbol">:tags</span>, ProductTagsDemo.Core.Tag, <span class="symbol">join_through:</span> <span class="string">&quot;products_tags&quot;</span></span><br><span class="line"></span><br><span class="line">  timestamps()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>(Note, that we don‚Äôt need to add this relationship on the other side, i.e., <code>Tag</code>
to get this working)</p>
<p>Now, we need to modify our <code>Product</code> form to show an input mechanism for tags,
the easy way to do this is to ask the users to provide a comma-separated list of
tags in an input textbox. A nicer way is to use a javascript library like
<a target="_blank" rel="noopener" href="https://select2.org/getting-started/basic-usage#multi-select-boxes-pillbox"><em>select2</em></a>.
For us, a text box with comma-separated tags will suffice.</p>
<p>The easiest way to do this is to add a text field like so:
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= label f, :tags %&gt;</span><br><span class="line">&lt;%= text_input f, :tags %&gt;</span><br><span class="line">&lt;%= error_tag f, :tags %&gt;</span><br></pre></td></tr></table></figure></p>
<p>However, as soon as you wire this up you‚Äôll get an error on the <code>/products/new</code>
page like below:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protocol Phoenix.HTML.Safe not implemented for #Ecto.Association.NotLoaded&lt;association :tags is not loaded&gt; of type Ecto.Association.NotLoaded (a struct).</span><br></pre></td></tr></table></figure>
This is telling us that the <code>to_string</code> function can‚Äôt convert an
<code>Ecto.Association.NotLoaded</code> struct into a string, When you have a relation like
a <code>belongs_to</code> or <code>has_one</code> or <code>many_to_many</code> that isn‚Äôt loaded on a struct, it
has this default value. This is coming from our controller, we can remedy this
by changing our action to the following:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span></span>(conn, _params) <span class="keyword">do</span></span><br><span class="line">  changeset = Core.change_product(%Product&#123;<span class="symbol">tags:</span> []&#125;)</span><br><span class="line">  render(conn, <span class="string">&quot;new.html&quot;</span>, <span class="symbol">changeset:</span> changeset)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Notice the <code>tags: []</code>, we are creating a new product with an empty tags
collection so that it renders properly in the form.</p>
<p>Now that we have fixed our form, we can try submitting some tags through this
form, However, when you enter any tags and hit <code>Save</code> it doesn‚Äôt do anything
which is not surprising because we haven‚Äôt set up the handling of these tags on
the backend yet.</p>
<p>We know that the <code>tags</code> field has comma-separated tags, so we need to do the
following to be able to save a product.</p>
<ol>
<li>Split tags on a comma.</li>
<li>Strip them of whitespace.</li>
<li>Lowercase them to get them to be homogeneous (If you want your tag names to
be persisted using the input casing and still treat the uppercased version
the same as the lowercased or capitalized versions, you can use <code>:citext</code>
(short for case insensitive text) read more about how to set up <code>:citext</code>
columns in my blog post about <a href="https://minhajuddin.com/2019/04/14/how-to-store-username-or-email-with-case-insensitive-search-using-ecto-part2/">storing username/email in a case insensitive
fashion</a>).</li>
<li>Once we have all the tag <code>names</code> we can insert any new tags and then fetch
the existing tags, combine them, and use <code>put_assoc</code> to put them on the
product.</li>
</ol>
<p>Step #4 creates a race condition in your code which can happen when 2 requests
try to create tags with the same name at the same time. An easy way to work
around this is to treat all the tags as new and do an upsert using
<code>Repo.insert_all</code> with an <code>on_conflict: :nothing</code> option which adds the fragment
<code>ON CONFLICT DO NOTHING</code> to your SQL making your query run successfully even if
there are tags with the same name in the database, it just doesn‚Äôt insert new
tags. Also, note that this function inserts all the tags in a single query doing
a bulk insert of all the input tags. Once you <code>upsert</code> all the tags, you can
then find them and use a <code>put_assoc</code> to create an association.</p>
<p>This is what ended up as the final <code>Core.create_product</code> function:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_product</span></span>(attrs \\ %&#123;&#125;) <span class="keyword">do</span></span><br><span class="line">  %Product&#123;&#125;</span><br><span class="line">  |&gt; Product.changeset(attrs)</span><br><span class="line">  <span class="comment"># use put_assoc to associate the input tags to the product</span></span><br><span class="line">  |&gt; Ecto.Changeset.put_assoc(<span class="symbol">:tags</span>, product_tags(attrs))</span><br><span class="line">  |&gt; Repo.insert()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">parse_tags</span></span>(<span class="keyword">nil</span>), <span class="symbol">do:</span> []</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">parse_tags</span></span>(tags) <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># Repo.insert_all requires the inserted_at and updated_at to be filled out</span></span><br><span class="line">  <span class="comment"># and they should have time truncated to the second that is why we need this</span></span><br><span class="line">  now = NaiveDateTime.utc_now() |&gt; NaiveDateTime.truncate(<span class="symbol">:second</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> tag &lt;- String.split(tags, <span class="string">&quot;,&quot;</span>),</span><br><span class="line">      tag = tag |&gt; String.trim() |&gt; String.downcase(),</span><br><span class="line">      tag != <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="symbol">do:</span> %&#123;<span class="symbol">name:</span> tag, <span class="symbol">inserted_at:</span> now, <span class="symbol">updated_at:</span> now&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">defp</span> <span class="title">product_tags</span></span>(attrs) <span class="keyword">do</span></span><br><span class="line">  tags = parse_tags(attrs[<span class="string">&quot;tags&quot;</span>]) <span class="comment"># =&gt; [%&#123;name: &quot;phone&quot;, inserted_at: ..&#125;,  ...]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># do an upsert ensuring that all the input tags are present</span></span><br><span class="line">  Repo.insert_all(Tag, tags, <span class="symbol">on_conflict:</span> <span class="symbol">:nothing</span>)</span><br><span class="line"></span><br><span class="line">  tag_names = <span class="keyword">for</span> t &lt;- tags, <span class="symbol">do:</span> t.name</span><br><span class="line">  <span class="comment"># find all the input tags</span></span><br><span class="line">  Repo.all(from t <span class="keyword">in</span> Tag, <span class="symbol">where:</span> t.name <span class="keyword">in</span> ^tag_names)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>It does the following:</p>
<ol>
<li>Normalize our tags</li>
<li>Ensure that all the tags are in our database using <code>Repo.insert_all</code> with
<code>on_conflict: :nothing</code> in a single SQL query.</li>
<li>Load all the tag structs using the names.</li>
<li>Use <code>put_assoc</code> to associate the tags with the newly created product.</li>
<li>From here <code>Ecto</code> takes over and makes sure that our product has the right
association records in the <code>products_tags</code> table</li>
</ol>
<p>Notice, how through all of our code we haven‚Äôt used the <code>products_tags</code> table
except for defining the <code>many_to_many</code> relationship in the <code>Product</code> schema.</p>
<p>This is all you need to insert a product with multiple tags, However, we still
want to show the tags of a product on the product details page. We can do this
by tweaking our action and the Core module like so:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">Core</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_product_with_tags!</span></span>(id), <span class="symbol">do:</span> Product |&gt; preload(<span class="symbol">:tags</span>) |&gt; Repo.get!(id)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">ProductTagsDemoWeb.ProductController</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span>(conn, %&#123;<span class="string">&quot;id&quot;</span> =&gt; id&#125;) <span class="keyword">do</span></span><br><span class="line">    product = Core.get_product_with_tags!(id)</span><br><span class="line">    render(conn, <span class="string">&quot;show.html&quot;</span>, <span class="symbol">product:</span> product)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Here we are preloading the tags with the product and we can use it in the view
like below to show all the tags for a product:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tags: &lt;%= (for tag &lt;- @product.tags, do: tag.name) |&gt; Enum.join(&quot;, &quot;) %&gt;</span><br></pre></td></tr></table></figure>
<p>This takes care of creating and showing a product with tags, However, if we try
to edit a product we are greeted with the following error:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protocol Phoenix.HTML.Safe not implemented for #Ecto.Association.NotLoaded&lt;association :tags is not loaded&gt; of type Ecto.Association.NotLoaded (a struct).</span><br></pre></td></tr></table></figure>
<p>Hmmm, we have seen this before when we rendered a new Product without tags,
However, in this case, our product does have tags but they haven‚Äôt been
loaded/preloaded. We can remedy that easily by tweaking our <code>edit</code> action to the
following:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span></span>(conn, %&#123;<span class="string">&quot;id&quot;</span> =&gt; id&#125;) <span class="keyword">do</span></span><br><span class="line">  product = Core.get_product_with_tags!(id)</span><br><span class="line">  changeset = Core.change_product(product)</span><br><span class="line">  render(conn, <span class="string">&quot;edit.html&quot;</span>, <span class="symbol">product:</span> product, <span class="symbol">changeset:</span> changeset)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>This gives us a new error:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lists in Phoenix.HTML and templates may only contain integers representing bytes, binaries or other lists, got invalid entry: %ProductTagsDemo.Core.Tag&#123;__meta__: #Ecto.Schema.Metadata&lt;:loaded, &quot;tags&quot;&gt;, id: 1, inserted_at: ~N[2020-05-04 05:20:45], name: &quot;phone&quot;, updated_at: ~N[2020-05-04 05:20:45]&#125;</span><br></pre></td></tr></table></figure>
<p>This is because we are using a <code>text_input</code> for a collection of tags and when
phoenix tries to convert the list of tags into a string it fails. This is a good
place to add a custom input function:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">ProductTagsDemoWeb.ProductView</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> ProductTagsDemoWeb, <span class="symbol">:view</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">tag_input</span></span>(form, field, opts \\ []) <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># get the input tags collection</span></span><br><span class="line">    tags = Phoenix.HTML.Form.input_value(form, field)</span><br><span class="line">    <span class="comment"># render text using the text_input after converting tags to text</span></span><br><span class="line">    Phoenix.HTML.Form.text_input(form, field, <span class="symbol">value:</span> tags_to_text(tags), opts)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">tags_to_text</span></span>(tags) <span class="keyword">do</span></span><br><span class="line">    tags</span><br><span class="line">    |&gt; Enum.map(<span class="keyword">fn</span> t -&gt; t.name <span class="keyword">end</span>)</span><br><span class="line">    |&gt; Enum.join(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>With this helper we can tweak our form to:
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= label f, :tags %&gt;</span><br><span class="line">&lt;%= tag_input f, :tags %&gt;</span><br><span class="line">&lt;%= error_tag f, :tags %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">&quot;help-text&quot;</span>&gt;</span>tags separated by commas<span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br></pre></td></tr></table></figure>
Note that the <code>text_input</code> has been changed to <code>tag_input</code>.</p>
<p>Now, when we go to edit a product, it should render the form with the tags
separated by commas. However, updating the product by changing tags still
doesn‚Äôt work because we haven‚Äôt updated our backend code to handle this. To
complete this, we need to tweak the controller and the <code>Core</code> context like so:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">ProductTagsDemoWeb.ProductController</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">update</span></span>(conn, %&#123;<span class="string">&quot;id&quot;</span> =&gt; id, <span class="string">&quot;product&quot;</span> =&gt; product_params&#125;) <span class="keyword">do</span></span><br><span class="line">    product = Core.get_product_with_tags!(id)</span><br><span class="line">    <span class="comment"># ... rest is the same</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">ProductTagsDemo.Core</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">update_product</span></span>(%Product&#123;&#125; = product, attrs) <span class="keyword">do</span></span><br><span class="line">    product</span><br><span class="line">    |&gt; Product.changeset(attrs)</span><br><span class="line">    |&gt; Ecto.Changeset.put_assoc(<span class="symbol">:tags</span>, product_tags(attrs))</span><br><span class="line">    |&gt; Repo.update()</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Note that in the controller we are using <code>get_product_with_tags!</code> and in the
context, we inserted a line to <code>put_assoc</code> similar to the <code>create_product</code>
function which does the same things as <code>create_product</code>.</p>
<p>Astute readers will observe that our create and update product implementation
doesn‚Äôt rollback newly created tags, when <code>create_product</code> or <code>update_product</code>
fails. Let us handle this case and wrap our post!</p>
<p>Ecto provides <code>Ecto.Multi</code> to allow easy database transaction handling. This
just needs changes to our context and our view like so:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">ProductTagsDemo.Core</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">alias</span> Ecto.Multi</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create_product</span></span>(attrs \\ %&#123;&#125;) <span class="keyword">do</span></span><br><span class="line">    multi_result =</span><br><span class="line">      Multi.new()</span><br><span class="line">      <span class="comment"># use multi to insert all the tags, so the tags are rolled back when there</span></span><br><span class="line">      <span class="comment"># is an error in product creation</span></span><br><span class="line">      |&gt; ensure_tags(attrs)</span><br><span class="line">      |&gt; Multi.insert(<span class="symbol">:product</span>, <span class="keyword">fn</span> %&#123;<span class="symbol">tags:</span> tags&#125; -&gt;</span><br><span class="line">        <span class="comment"># This chunk of code remains the same, the only difference is we let</span></span><br><span class="line">        <span class="comment"># Ecto.Multi handle insertion of the product</span></span><br><span class="line">        %Product&#123;&#125;</span><br><span class="line">        |&gt; Product.changeset(attrs)</span><br><span class="line">        |&gt; Ecto.Changeset.put_assoc(<span class="symbol">:tags</span>, tags)</span><br><span class="line">      <span class="keyword">end</span>)</span><br><span class="line">      <span class="comment"># Finally, we run all of this in a single transaction</span></span><br><span class="line">      |&gt; Repo.transaction()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># a multi result can be an :ok tagged tuple with the data from all steps</span></span><br><span class="line">    <span class="comment"># or an error tagged tuple with the failure step&#x27;s atom and relevant data</span></span><br><span class="line">    <span class="comment"># in this case we only expect failures in Product insertion</span></span><br><span class="line">    <span class="keyword">case</span> multi_result <span class="keyword">do</span></span><br><span class="line">      &#123;<span class="symbol">:ok</span>, %&#123;<span class="symbol">product:</span> product&#125;&#125; -&gt; &#123;<span class="symbol">:ok</span>, product&#125;</span><br><span class="line">      &#123;<span class="symbol">:error</span>, <span class="symbol">:product</span>, changeset, _&#125; -&gt; &#123;<span class="symbol">:error</span>, changeset&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># This is identical to `create_product`</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">update_product</span></span>(%Product&#123;&#125; = product, attrs) <span class="keyword">do</span></span><br><span class="line">    multi_result =</span><br><span class="line">      Multi.new()</span><br><span class="line">      |&gt; ensure_tags(attrs)</span><br><span class="line">      |&gt; Multi.update(<span class="symbol">:product</span>, <span class="keyword">fn</span> %&#123;<span class="symbol">tags:</span> tags&#125; -&gt;</span><br><span class="line">        product</span><br><span class="line">        |&gt; Product.changeset(attrs)</span><br><span class="line">        |&gt; Ecto.Changeset.put_assoc(<span class="symbol">:tags</span>, tags)</span><br><span class="line">      <span class="keyword">end</span>)</span><br><span class="line">      |&gt; Repo.transaction()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> multi_result <span class="keyword">do</span></span><br><span class="line">      &#123;<span class="symbol">:ok</span>, %&#123;<span class="symbol">product:</span> product&#125;&#125; -&gt; &#123;<span class="symbol">:ok</span>, product&#125;</span><br><span class="line">      &#123;<span class="symbol">:error</span>, <span class="symbol">:product</span>, changeset, _&#125; -&gt; &#123;<span class="symbol">:error</span>, changeset&#125;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># parse_tags is unchanged</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># We have created an ensure tags to use the multi struct passed along and the</span></span><br><span class="line">  <span class="comment"># repo associated with it to allow rolling back tag inserts</span></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">ensure_tags</span></span>(multi, attrs) <span class="keyword">do</span></span><br><span class="line">    tags = parse_tags(attrs[<span class="string">&quot;tags&quot;</span>])</span><br><span class="line"></span><br><span class="line">    multi</span><br><span class="line">    |&gt; Multi.insert_all(<span class="symbol">:insert_tags</span>, Tag, tags, <span class="symbol">on_conflict:</span> <span class="symbol">:nothing</span>)</span><br><span class="line">    |&gt; Multi.run(<span class="symbol">:tags</span>, <span class="keyword">fn</span> repo, _changes -&gt;</span><br><span class="line">      tag_names = <span class="keyword">for</span> t &lt;- tags, <span class="symbol">do:</span> t.name</span><br><span class="line">      &#123;<span class="symbol">:ok</span>, repo.all(from t <span class="keyword">in</span> Tag, <span class="symbol">where:</span> t.name <span class="keyword">in</span> ^tag_names)&#125;</span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">ProductTagsDemoWeb.ProductView</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> ProductTagsDemoWeb, <span class="symbol">:view</span></span><br><span class="line">  <span class="keyword">import</span> Phoenix.HTML.Form</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">tag_input</span></span>(form, field, opts \\ []) <span class="keyword">do</span></span><br><span class="line">    text_input(form, field, <span class="symbol">value:</span> tag_value(form.source, form, field))</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># if there is an error, pass the input params along</span></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">tag_value</span></span>(%Ecto.Changeset&#123;<span class="symbol">valid?:</span> <span class="keyword">false</span>&#125;, form, field) <span class="keyword">do</span></span><br><span class="line">    form.params[to_string(field)]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">tag_value</span></span>(_source, form, field) <span class="keyword">do</span></span><br><span class="line">    form</span><br><span class="line">    |&gt; input_value(field)</span><br><span class="line">    |&gt; tags_to_text</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">tags_to_text</span></span>(tags) <span class="keyword">do</span></span><br><span class="line">    tags</span><br><span class="line">    |&gt; Enum.map(<span class="keyword">fn</span> t -&gt; t.name <span class="keyword">end</span>)</span><br><span class="line">    |&gt; Enum.join(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Whew, that was long, but hopefully, this gives you a comprehensive understanding
of how to handle <code>many_to_many</code> relationships in Ecto and Phoenix.</p>
<p>The source code associated with this blog post can be found at <a target="_blank" rel="noopener" href="https://github.com/minhajuddin/product_tags_demo">https://github.com/minhajuddin/product_tags_demo</a></p>
<p>P.S. There is a lot of duplication in our final <code>create_product</code> and
<code>update_product</code> functions, try removing the duplication in an elegant way! I‚Äôll
share my take on it in the next post!</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2020/05/03/many-to-many-relationships-in-ecto-and-phoenix-for-products-and-tags/" data-id="ckvg57nrv00r2cdol1kst3fiz" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2020/05/03/many-to-many-relationships-in-ecto-and-phoenix-for-products-and-tags/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ecto/" rel="tag">Ecto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/phoenix/" rel="tag">Phoenix</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tags/" rel="tag">Tags</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/many-to-many/" rel="tag">many_to_many</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/relationships/" rel="tag">relationships</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-dump-a-partial-sample-table-1000-rows-in-postgres-using-pg-dump" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/30/how-to-dump-a-partial-sample-table-1000-rows-in-postgres-using-pg-dump/" class="article-date">
  <time datetime="2019-11-30T00:36:13.000Z" itemprop="datePublished">2019-11-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/30/how-to-dump-a-partial-sample-table-1000-rows-in-postgres-using-pg-dump/">How to dump a partial/sample table(1000 rows) in postgres using pg_dump</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The other day, I wanted to export a sample of one of my big Postgres tables from
the production server to my local computer. This was a huge table and I didn‚Äôt
want to move around a few GBs just to get a sample onto my local environment.
Unfortunately <code>pg_dump</code> doesn‚Äôt support exporting of partial tables. I looked
around and found a utility called <a target="_blank" rel="noopener" href="https://github.com/mla/pg_sample">pg_sample</a>
which is supposed to help you with this. However, I wasn‚Äôt comfortable with
installing this on my production server or letting my production data through
this script. Thinking a little more made the solution obvious. The idea was
simple:</p>
<ol>
<li>Create a table called <code>tmp_page_caches</code> where <code>page_caches</code> is the table that
you want to copy using <code>pg_dump</code> using the following SQL in <code>psql</code>, this
gives you a lot of freedom on SELECTing just the rows you want.<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_page_caches <span class="keyword">AS</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> page_caches LIMIT <span class="number">1000</span>);</span><br></pre></td></tr></table></figure></li>
<li>Export this table using <code>pg_dump</code> as below. Here we are exporting the data to
a sql file and transforming our table name to the original table name
midstream.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_dump app_production --table tmp_page_caches | sed <span class="string">&#x27;s/public.tmp_/public./&#x27;</span> &gt; page_caches.sql</span><br></pre></td></tr></table></figure></li>
<li>Copy this file to the local server using <code>scp</code> and now run it against the
local database:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp minhajuddin@server.prod:page_caches.sql .</span><br><span class="line">psql app_development &lt; page_caches.sql</span><br></pre></td></tr></table></figure></li>
<li>Get rid of the temporary table on the production server<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> tmp_page_caches; <span class="comment">-- be careful not to drop the real table!</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Voila! We have successfully copied over a sample of our production table to our
local environment. Hope you find it useful.</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2019/11/30/how-to-dump-a-partial-sample-table-1000-rows-in-postgres-using-pg-dump/" data-id="ckvg57nko003tcdolgxx26gbl" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2019/11/30/how-to-dump-a-partial-sample-table-1000-rows-in-postgres-using-pg-dump/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/limit/" rel="tag">limit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/partial-table/" rel="tag">partial table</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pg-dump/" rel="tag">pg_dump</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sample/" rel="tag">sample</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-copy-output-of-a-function-to-your-clipboard-in-elixir-or-ruby" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/03/how-to-copy-output-of-a-function-to-your-clipboard-in-elixir-or-ruby/" class="article-date">
  <time datetime="2019-06-03T17:51:36.000Z" itemprop="datePublished">2019-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/03/how-to-copy-output-of-a-function-to-your-clipboard-in-elixir-or-ruby/">How to copy output of a function to your clipboard in Elixir or Ruby</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Having the ability to drive your development using just a keyboard is very
productive. However, when you are using a terminal and have to copy the output
of a command to use it somewhere else, it breaks your flow, you need to move
your hands away from your keyboard, use the mouse to select the text and then
copy it.</p>
<p>When I want to copy passwords to be used elsewhere from my browser, I usually
open the developer tools console, inspect element and click on the password
input box and then run the following code:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy($<span class="number">0.</span>value)</span><br></pre></td></tr></table></figure>
<p>Chrome sets <code>$0</code> to refer to the currently selected DOM element and <code>$0.value</code>
will give us the value of the password field and sending it to the <code>copy</code>
function copies this text to the OS clipboard.</p>
<p>I have a similar script set up for my terminal, when I want to copy the output
of a command like <code>rake secret</code> I run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rake secret | xc <span class="comment"># copies a new secret to the clipboard.</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello&quot;</span> | xc <span class="comment"># copies the string `Hello` to the clipboard.</span></span><br></pre></td></tr></table></figure>
<p><code>xc</code> is aliased to the following in my bashrc:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> xc=<span class="string">&#x27;tee /dev/tty | xclip -selection clipboard&#x27;</span></span><br></pre></td></tr></table></figure>
<p>This command prints the output to the terminal (using <code>tee /dev/tty</code>) and copies
it to the OS clipboard using the <code>xclip</code> package.</p>
<p>I wanted the same ability in my ruby and elixir REPLs. It was pretty
straightforward to do in ruby. Here is the annotated code:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">puts <span class="string">&#x27;loading ~/.pryrc ...&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;open3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy takes an argument and converts it into a string and copies it to the OS</span></span><br><span class="line"><span class="comment"># clipboard using the `xclip` command line package.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">copy</span><span class="params">(text)</span></span></span><br><span class="line">  <span class="comment"># start running the `xclip` command to copy the stdin to the OS primary</span></span><br><span class="line">  <span class="comment"># clipboard. Also pass the stdin and stdout, stderr to the block</span></span><br><span class="line">  Open3.popen3(<span class="string">&#x27;xclip&#x27;</span>, <span class="string">&#x27;-selection&#x27;</span>, <span class="string">&#x27;clipboard&#x27;</span>) <span class="keyword">do</span> <span class="params">|stdin, _stdout, _stderr, _wait_thr|</span></span><br><span class="line">    <span class="comment"># convert the input argument to a string and write it to the stdin of the</span></span><br><span class="line">    <span class="comment"># spawned `xclip` process and the close the input stream</span></span><br><span class="line">    stdin.puts text.to_s</span><br><span class="line">    stdin.close</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># print out an informational message to signal that the argument has been</span></span><br><span class="line">  <span class="comment"># copied to the clipboard.</span></span><br><span class="line">  puts <span class="string">&quot;copied to clipboard: <span class="subst">#&#123;text.to_s[<span class="number">0</span>..<span class="number">10</span>]&#125;</span>...&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># e.g. running `copy SecureRandom.uuid` will print the following</span></span><br><span class="line"><span class="comment"># pry(main)&gt; copy SecureRandom.uuid</span></span><br><span class="line"><span class="comment"># copied to clipboard: 14438d5c-62...</span></span><br><span class="line"><span class="comment"># and copies: `14438d5c-62b9-40a1-a324-5d2bd2205990` to the OS clipboard</span></span><br></pre></td></tr></table></figure>
<p>Below is a similar script for Elixir:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">IO.puts(<span class="string">&quot;loading ~/.iex.exs&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open a module called `H` as we can&#x27;t have functions outside modules</span></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">H</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># copy function takes the input and converts it into a string before copying</span></span><br><span class="line">  <span class="comment"># it to the OS clipboard.</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">copy</span></span>(text) <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># convert input argument to a string</span></span><br><span class="line">    text = to_s(text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># spawn a new xclip process configured to copy the stdin to the OS&#x27;s primary</span></span><br><span class="line">    <span class="comment"># clipboard</span></span><br><span class="line">    port = Port.open(&#123;<span class="symbol">:spawn</span>, <span class="string">&quot;xclip -selection clipboard&quot;</span>&#125;, [])</span><br><span class="line">    <span class="comment"># send the input text as stdin to the xclip process</span></span><br><span class="line">    Port.command(port, text)</span><br><span class="line">    <span class="comment"># close the port</span></span><br><span class="line">    Port.close(port)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print out an informational message to signal that the text has been copied</span></span><br><span class="line">    <span class="comment"># to the OS&#x27;s clipboard&quot;</span></span><br><span class="line">    IO.puts(<span class="string">&quot;copied to clipboard: <span class="subst">#&#123;String.slice(text, 0, <span class="number">10</span>)&#125;</span>...&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># to_s converts an elixir term to a string if it implements the `String.Chars`</span></span><br><span class="line">  <span class="comment"># protocol otherwise it uses `inspect` to convert it into a string.</span></span><br><span class="line">  <span class="function"><span class="keyword">defp</span> <span class="title">to_s</span></span>(text) <span class="keyword">do</span></span><br><span class="line">    to_string(text)</span><br><span class="line">  rescue</span><br><span class="line">    _ -&gt; inspect(text)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iex(<span class="number">2</span>)&gt; <span class="symbol">:crypto</span>.strong_rand_bytes(<span class="number">16</span>) |&gt; Base.encode16 |&gt; H.copy</span><br><span class="line"><span class="comment"># copied to clipboard: 347B175C6F...</span></span><br><span class="line"><span class="comment"># it has also copied `347B175C6F397B2808DE7168444ED428` to the OS&#x27;s clipboard</span></span><br></pre></td></tr></table></figure>
<p>All these utilities (except for the browser‚Äôs <code>copy</code> function) depend on the
<code>xclip</code> utility which can be installed on ubuntu using <code>sudo apt-get install
xclip</code>. You can emulate the same behaviour on a Mac using the <code>pbcopy</code> utility,
you might have to tweak things a little bit, but it should be pretty straightforward.</p>
<p>You can do the same in your favorite programming language too, just find the
right way to spawn an <code>xclip</code> process and send the text you want to be copied to
its‚Äô stdin. Hope this makes your development a little more pleasant :)</p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2019/06/03/how-to-copy-output-of-a-function-to-your-clipboard-in-elixir-or-ruby/" data-id="ckvg57nkj003fcdolfkm5b4uh" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2019/06/03/how-to-copy-output-of-a-function-to-your-clipboard-in-elixir-or-ruby/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iex/" rel="tag">IEx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/irb/" rel="tag">IRB</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pry/" rel="tag">Pry</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ruby/" rel="tag">Ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/copy/" rel="tag">copy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pbcopy/" rel="tag">pbcopy</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xclip/" rel="tag">xclip</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-how-to-store-username-or-email-with-case-insensitive-search-using-ecto-part2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/14/how-to-store-username-or-email-with-case-insensitive-search-using-ecto-part2/" class="article-date">
  <time datetime="2019-04-14T10:59:55.000Z" itemprop="datePublished">2019-04-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/14/how-to-store-username-or-email-with-case-insensitive-search-using-ecto-part2/">How to store username or email with case insensitive search using Ecto - Part 2</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In a previous blog post I was trying to <a href="/2019/04/14/how-to-store-username-or-email-with-case-insensitive-search-using-ecto/">store username/email in a case
insensitive way in
postgres</a>.
A few folks commented that the <code>citext</code> postgres extension actually did this in
a very easy and straightforward way. So, I went back to my code and ripped out
the unnecessary complexity and here is what I ended up with:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">SF.Repo.Migrations.EnableCitextExtension</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> Ecto.Migration</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span> <span class="keyword">do</span></span><br><span class="line">    execute <span class="string">&quot;CREATE EXTENSION citext&quot;</span>, <span class="string">&quot;DROP EXTENSION citext&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"> SF.Repo.Migrations.CreateUsers <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> Ecto.Migration</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">change</span></span> <span class="keyword">do</span></span><br><span class="line">    create table(<span class="symbol">:users</span>, <span class="symbol">primary_key:</span> <span class="keyword">false</span>) <span class="keyword">do</span></span><br><span class="line">      add <span class="symbol">:id</span>, <span class="symbol">:binary_id</span>, <span class="symbol">primary_key:</span> <span class="keyword">true</span></span><br><span class="line">      add <span class="symbol">:email</span>, <span class="symbol">:citext</span>, <span class="symbol">null:</span> <span class="keyword">false</span></span><br><span class="line">      add <span class="symbol">:magic_token</span>, <span class="symbol">:uuid</span></span><br><span class="line">      add <span class="symbol">:magic_token_created_at</span>, <span class="symbol">:naive_datetime</span></span><br><span class="line">      add <span class="symbol">:confirmation_token</span>, <span class="symbol">:uuid</span></span><br><span class="line">      add <span class="symbol">:confirmed_at</span>, <span class="symbol">:naive_datetime</span></span><br><span class="line"></span><br><span class="line">      timestamps()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    create index(<span class="symbol">:users</span>, [<span class="symbol">:email</span>], <span class="symbol">unique:</span> <span class="keyword">true</span>)</span><br><span class="line">    create index(<span class="symbol">:users</span>, [<span class="symbol">:magic_token</span>], <span class="symbol">unique:</span> <span class="keyword">true</span>)</span><br><span class="line">    create index(<span class="symbol">:users</span>, [<span class="symbol">:confirmation_token</span>], <span class="symbol">unique:</span> <span class="keyword">true</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">SF.User</span></span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">use</span> Ecto.Schema</span><br><span class="line">  <span class="keyword">import</span> Ecto.Changeset</span><br><span class="line"></span><br><span class="line">  <span class="variable">@primary_key</span> &#123;<span class="symbol">:id</span>, <span class="symbol">:binary_id</span>, <span class="symbol">autogenerate:</span> <span class="keyword">true</span>&#125;</span><br><span class="line">  <span class="variable">@foreign_key_type</span> <span class="symbol">:binary_id</span></span><br><span class="line">  schema <span class="string">&quot;users&quot;</span> <span class="keyword">do</span></span><br><span class="line">    field <span class="symbol">:email</span>, <span class="symbol">:string</span></span><br><span class="line">    field <span class="symbol">:magic_token</span>, Ecto.Base64UUID</span><br><span class="line">    field <span class="symbol">:confirmation_token</span>, Ecto.Base64UUID</span><br><span class="line">    field <span class="symbol">:confirmed_at</span>, <span class="symbol">:naive_datetime</span></span><br><span class="line"></span><br><span class="line">    timestamps()</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">@doc</span> <span class="keyword">false</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">changeset</span></span>(user, attrs) <span class="keyword">do</span></span><br><span class="line">    user</span><br><span class="line">    |&gt; cast(attrs, [<span class="symbol">:email</span>, <span class="symbol">:confirmation_token</span>])</span><br><span class="line">    |&gt; validate_required([<span class="symbol">:email</span>])</span><br><span class="line">    |&gt; unique_constraint(<span class="symbol">:email</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">defmodule</span> <span class="title">SF.UserService</span></span> <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">find_by_email</span></span>(email) <span class="keyword">do</span></span><br><span class="line">    Repo.one(from u <span class="keyword">in</span> User, <span class="symbol">where:</span> u.email == ^email)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>So, the way <a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/11/citext.html">citext</a> works is
similar to our previous approach. If you want to get into all the gory details
about how citext is implemented you can check out the code on GitHub at:
<a target="_blank" rel="noopener" href="https://github.com/postgres/postgres/blob/6dd86c269d5b9a176f6c9f67ea61cc17fef9d860/contrib/citext/citext.c">https://github.com/postgres/postgres/blob/6dd86c269d5b9a176f6c9f67ea61cc17fef9d860/contrib/citext/citext.c</a></p>

        
      


      

    </div>
    <footer class="article-footer">
      <a data-url="http://minhajuddin.com/2019/04/14/how-to-store-username-or-email-with-case-insensitive-search-using-ecto-part2/" data-id="ckvg57nlf0058cdol7dvlazm8" class="article-share-link">Share</a>
      
        <a href="http://minhajuddin.com/2019/04/14/how-to-store-username-or-email-with-case-insensitive-search-using-ecto-part2/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ecto/" rel="tag">Ecto</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/email/" rel="tag">Email</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/index/" rel="tag">Index</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgresql/" rel="tag">Postgresql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/username/" rel="tag">Username</a></li></ul>

    </footer>
  </div>
  
</article>



  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  

        </section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap highlighted-widget">
  <div class="widget">
    Thanks for visiting my blog. If you find this content interesting, Please take a look at
    <a target="_blank" rel="noopener" href='https://liveformhq.com/?utm_source=minhajuddin.com'>LiveForm, it provides you with a simple way to host Online Forms for your websites. Be it Contact Forms/Feedback Forms or any custom forms.</a>.
    <div style='text-align: center; margin-top: 10px;' >
      <a target="_blank" rel="noopener" href='https://liveformhq.com/registrations/new?plan=starter' style='text-decoration: none; text-align: center;display: inline-block; padding: 10px 50px; background-color: #ff3e01; color: white;' >
      Sign up now!
      </a>
    </div>
  </div>
</div>

<div class="widget-wrap">
  <h3 class="widget-title">Resources</h3>
  <div class="widget">
    <ul>
      <li><a href='/about/'>About Me</a></li>
      <li><a href='/projects/'>My Projects</a></li>
      <li><a target="_blank" rel="noopener" href='https://github.com/minhajuddin'>Github</a></li>
      <li><a target="_blank" rel="noopener" href='https://twitter.com/minhajuddin'>@minhajuddin</a></li>
      <li><a href='/atom.xml'>Subscribe</a></li>
    </ul>
  </div>
</div>

<div class="widget-wrap">
  <h3 class="widget-title">Side Projects</h3>
  <div class="widget">
    <ul>
      <li><a target="_blank" rel="noopener" href='http://readcode.in/'>Readcode - Makes reading source code a pleasure</a></li>
      <li><a target="_blank" rel="noopener" href='https://getsimpleform.com/'>Simple Form - Build simple online forms</a></li>
      <li><a target="_blank" rel="noopener" href='https://liveformhq.com/'>LiveForm - Online forms for professional designers and developers</a></li>
      <li><a target="_blank" rel="noopener" href='http://getsimplesite.com/'>SimpleSite - A powerful javascript based CMS</a></li>
      <li><a target="_blank" rel="noopener" href='http://www.websrvr.in/'>Websrvr - Host your websites using Dropbox</a></li>
      <li><a target="_blank" rel="noopener" href='http://www.schoolone.in/'>SchoolOne - A solution for your school management</a></li>
      <li><a target="_blank" rel="noopener" href='https://simplemessage.in/'>SimpleMessage - Send SMS messages with a powerful UI</a></li>
      <li><a target="_blank" rel="noopener" href='https://slugex.com/'>Slugex - Host your apps using CLI</a></li>
    </ul>
  </div>
</div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/31/memory-cached-tables-for-building-faster-web-applications/">Memory Cached Tables for building faster web applications</a>
          </li>
        
          <li>
            <a href="/2021/04/20/a-baton-server-to-test-your-erlang-elixir-cluster/">A baton server to test your Erlang/Elixir cluster</a>
          </li>
        
          <li>
            <a href="/2021/04/15/how-to-show-raspberry-pi-temperatures-in-your-datadog-dashboard/">How to show Raspberry Pi temperatures in your Datadog dashboard</a>
          </li>
        
          <li>
            <a href="/2021/03/14/how-to-rename-table-using-pg-dump-or-pg-restore/">How to rename table using pg_dump or pg_restore</a>
          </li>
        
          <li>
            <a href="/2021/03/07/moving-a-rails-managed-database-to-phoenix/">Moving a Rails managed database to Phoenix</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/aws/" style="font-size: 12.5px;">AWS</a> <a href="/tags/advent-of-code/" style="font-size: 10px;">Advent Of Code</a> <a href="/tags/advent-of-code/" style="font-size: 13.75px;">Advent of Code</a> <a href="/tags/analyze/" style="font-size: 10px;">Analyze</a> <a href="/tags/atom/" style="font-size: 10px;">Atom</a> <a href="/tags/aurora/" style="font-size: 10px;">Aurora</a> <a href="/tags/auto-renew/" style="font-size: 10px;">Auto renew</a> <a href="/tags/automatic-generation/" style="font-size: 10px;">Automatic Generation</a> <a href="/tags/backpressure/" style="font-size: 10px;">Backpressure</a> <a href="/tags/bash-completion/" style="font-size: 10px;">Bash completion</a> <a href="/tags/bastion/" style="font-size: 10px;">Bastion</a> <a href="/tags/baton/" style="font-size: 10px;">Baton</a> <a href="/tags/bench/" style="font-size: 10px;">Bench</a> <a href="/tags/benchmark/" style="font-size: 10px;">Benchmark</a> <a href="/tags/binary/" style="font-size: 10px;">Binary</a> <a href="/tags/bits/" style="font-size: 10px;">Bits</a> <a href="/tags/blog/" style="font-size: 10px;">Blog</a> <a href="/tags/callbacks/" style="font-size: 10px;">Callbacks</a> <a href="/tags/case-insensitive/" style="font-size: 10px;">Case insensitive</a> <a href="/tags/cassette/" style="font-size: 10px;">Cassette</a> <a href="/tags/cluster/" style="font-size: 10px;">Cluster</a> <a href="/tags/concatenate/" style="font-size: 10px;">Concatenate</a> <a href="/tags/concurrency/" style="font-size: 10px;">Concurrency</a> <a href="/tags/copy/" style="font-size: 10px;">Copy</a> <a href="/tags/cowboy/" style="font-size: 10px;">Cowboy</a> <a href="/tags/dry/" style="font-size: 10px;">DRY</a> <a href="/tags/database/" style="font-size: 10px;">Database</a> <a href="/tags/debug/" style="font-size: 11.25px;">Debug</a> <a href="/tags/deploy/" style="font-size: 10px;">Deploy</a> <a href="/tags/distillery/" style="font-size: 10px;">Distillery</a> <a href="/tags/distributed/" style="font-size: 10px;">Distributed</a> <a href="/tags/docker/" style="font-size: 10px;">Docker</a> <a href="/tags/documentation/" style="font-size: 10px;">Documentation</a> <a href="/tags/duplication/" style="font-size: 10px;">Duplication</a> <a href="/tags/ec2/" style="font-size: 10px;">EC2</a> <a href="/tags/ecs/" style="font-size: 10px;">ECS</a> <a href="/tags/erb/" style="font-size: 10px;">ERB</a> <a href="/tags/ecto/" style="font-size: 17.5px;">Ecto</a> <a href="/tags/elixir/" style="font-size: 20px;">Elixir</a> <a href="/tags/elm/" style="font-size: 10px;">Elm</a> <a href="/tags/email/" style="font-size: 11.25px;">Email</a> <a href="/tags/enqueue/" style="font-size: 10px;">Enqueue</a> <a href="/tags/enum/" style="font-size: 10px;">Enum</a> <a href="/tags/environment-loader/" style="font-size: 10px;">Environment Loader</a> <a href="/tags/environment-variables/" style="font-size: 10px;">Environment Variables</a> <a href="/tags/erlang/" style="font-size: 10px;">Erlang</a> <a href="/tags/error/" style="font-size: 10px;">Error</a> <a href="/tags/exvcr/" style="font-size: 10px;">ExVCR</a> <a href="/tags/fast/" style="font-size: 10px;">Fast</a> <a href="/tags/fizzbuzz/" style="font-size: 10px;">FizzBuzz</a> <a href="/tags/functional-programming/" style="font-size: 10px;">Functional Programming</a> <a href="/tags/genserver/" style="font-size: 10px;">GenServer</a> <a href="/tags/git/" style="font-size: 10px;">Git</a> <a href="/tags/github-pages/" style="font-size: 10px;">GitHub Pages</a> <a href="/tags/go/" style="font-size: 10px;">Go</a> <a href="/tags/google-chrome/" style="font-size: 10px;">Google Chrome</a> <a href="/tags/guard/" style="font-size: 10px;">Guard</a> <a href="/tags/hmac/" style="font-size: 10px;">HMAC</a> <a href="/tags/heroku/" style="font-size: 11.25px;">Heroku</a> <a href="/tags/hex/" style="font-size: 10px;">Hex</a> <a href="/tags/hotkeys/" style="font-size: 10px;">Hotkeys</a> <a href="/tags/how-to/" style="font-size: 10px;">How To</a> <a href="/tags/how-to/" style="font-size: 10px;">How to</a> <a href="/tags/iex/" style="font-size: 10px;">IEx</a> <a href="/tags/irb/" style="font-size: 10px;">IRB</a> <a href="/tags/index/" style="font-size: 11.25px;">Index</a> <a href="/tags/isolated/" style="font-size: 10px;">Isolated</a> <a href="/tags/json/" style="font-size: 10px;">JSON</a> <a href="/tags/key-transform/" style="font-size: 10px;">Key Transform</a> <a href="/tags/key-value/" style="font-size: 10px;">Key-Value</a> <a href="/tags/large/" style="font-size: 10px;">Large</a> <a href="/tags/learn/" style="font-size: 10px;">Learn</a> <a href="/tags/lets-encrypt/" style="font-size: 10px;">Lets encrypt</a> <a href="/tags/lists/" style="font-size: 10px;">Lists</a> <a href="/tags/lookup-tables/" style="font-size: 10px;">Lookup tables</a> <a href="/tags/md5/" style="font-size: 10px;">MD5</a> <a href="/tags/map/" style="font-size: 11.25px;">Map</a> <a href="/tags/meetup/" style="font-size: 10px;">Meetup</a> <a href="/tags/memory-cached-tables/" style="font-size: 10px;">Memory Cached Tables</a> <a href="/tags/migration/" style="font-size: 11.25px;">Migration</a> <a href="/tags/mix/" style="font-size: 10px;">Mix</a> <a href="/tags/multiple/" style="font-size: 10px;">Multiple</a> <a href="/tags/network/" style="font-size: 10px;">Network</a> <a href="/tags/nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/nokogiri/" style="font-size: 10px;">Nokogiri</a> <a href="/tags/order/" style="font-size: 10px;">Order</a> <a href="/tags/pdf/" style="font-size: 10px;">PDF</a> <a href="/tags/pandora/" style="font-size: 10px;">Pandora</a> <a href="/tags/parameter-store/" style="font-size: 10px;">Parameter Store</a> <a href="/tags/pattern-matching/" style="font-size: 10px;">Pattern matching</a> <a href="/tags/pearls/" style="font-size: 10px;">Pearls</a> <a href="/tags/perf/" style="font-size: 10px;">Perf</a> <a href="/tags/performance/" style="font-size: 10px;">Performance</a> <a href="/tags/phoenix/" style="font-size: 18.75px;">Phoenix</a> <a href="/tags/pianobar/" style="font-size: 11.25px;">Pianobar</a> <a href="/tags/pipelines/" style="font-size: 10px;">Pipelines</a> <a href="/tags/plug/" style="font-size: 11.25px;">Plug</a> <a href="/tags/postgres/" style="font-size: 10px;">Postgres</a> <a href="/tags/postgres-provider/" style="font-size: 10px;">Postgres provider</a> <a href="/tags/postgresql/" style="font-size: 12.5px;">Postgresql</a> <a href="/tags/presentation/" style="font-size: 10px;">Presentation</a> <a href="/tags/process/" style="font-size: 10px;">Process</a> <a href="/tags/product/" style="font-size: 10px;">Product</a> <a href="/tags/proxy/" style="font-size: 10px;">Proxy</a> <a href="/tags/proxyjump/" style="font-size: 10px;">ProxyJump</a> <a href="/tags/pry/" style="font-size: 10px;">Pry</a> <a href="/tags/python/" style="font-size: 10px;">Python</a> <a href="/tags/rds/" style="font-size: 10px;">RDS</a> <a href="/tags/rails/" style="font-size: 11.25px;">Rails</a> <a href="/tags/rails-migrations/" style="font-size: 10px;">Rails Migrations</a> <a href="/tags/redis/" style="font-size: 12.5px;">Redis</a> <a href="/tags/restricted/" style="font-size: 10px;">Restricted</a> <a href="/tags/restricted-subdomains/" style="font-size: 10px;">Restricted Subdomains</a> <a href="/tags/retrieval/" style="font-size: 10px;">Retrieval</a> <a href="/tags/ruby/" style="font-size: 16.25px;">Ruby</a> <a href="/tags/ssh/" style="font-size: 10px;">SSH</a> <a href="/tags/saas-tip/" style="font-size: 10px;">SaaS Tip</a> <a href="/tags/secrets/" style="font-size: 10px;">Secrets</a> <a href="/tags/semver/" style="font-size: 10px;">SemVer</a> <a href="/tags/server/" style="font-size: 10px;">Server</a> <a href="/tags/sidekiq/" style="font-size: 10px;">Sidekiq</a> <a href="/tags/sign-request/" style="font-size: 10px;">Sign Request</a> <a href="/tags/sleep/" style="font-size: 10px;">Sleep</a> <a href="/tags/speed/" style="font-size: 10px;">Speed</a> <a href="/tags/startup/" style="font-size: 10px;">Startup</a> <a href="/tags/static-site-generator/" style="font-size: 10px;">Static Site Generator</a> <a href="/tags/static-sites/" style="font-size: 10px;">Static Sites</a> <a href="/tags/string/" style="font-size: 10px;">String</a> <a href="/tags/structure/" style="font-size: 10px;">Structure</a> <a href="/tags/til/" style="font-size: 10px;">TIL</a> <a href="/tags/tags/" style="font-size: 12.5px;">Tags</a> <a href="/tags/task/" style="font-size: 10px;">Task</a> <a href="/tags/terraform/" style="font-size: 12.5px;">Terraform</a> <a href="/tags/ticker/" style="font-size: 10px;">Ticker</a> <a href="/tags/timeout/" style="font-size: 10px;">Timeout</a> <a href="/tags/tip/" style="font-size: 10px;">Tip</a> <a href="/tags/tmux/" style="font-size: 11.25px;">Tmux</a> <a href="/tags/user/" style="font-size: 10px;">User</a> <a href="/tags/username/" style="font-size: 11.25px;">Username</a> <a href="/tags/version/" style="font-size: 10px;">Version</a> <a href="/tags/vim/" style="font-size: 11.25px;">Vim</a> <a href="/tags/web-apps/" style="font-size: 10px;">Web apps</a> <a href="/tags/webpipe/" style="font-size: 10px;">Webpipe</a> <a href="/tags/xml/" style="font-size: 10px;">Xml</a> <a href="/tags/xml-pluck/" style="font-size: 10px;">Xml Pluck</a> <a href="/tags/ajax/" style="font-size: 10px;">ajax,</a> <a href="/tags/algorithm/" style="font-size: 11.25px;">algorithm</a> <a href="/tags/angularjs/" style="font-size: 10px;">angularjs</a> <a href="/tags/api/" style="font-size: 10px;">api</a> <a href="/tags/authenticate/" style="font-size: 10px;">authenticate</a> <a href="/tags/automate/" style="font-size: 10px;">automate</a> <a href="/tags/automatic/" style="font-size: 10px;">automatic</a> <a href="/tags/banshee/" style="font-size: 10px;">banshee,</a> <a href="/tags/barefooters/" style="font-size: 10px;">barefooters</a> <a href="/tags/bash/" style="font-size: 13.75px;">bash</a> <a href="/tags/batch/" style="font-size: 10px;">batch</a> <a href="/tags/bookmarklet/" style="font-size: 11.25px;">bookmarklet</a> <a href="/tags/books/" style="font-size: 10px;">books</a> <a href="/tags/brute-force/" style="font-size: 10px;">brute-force</a> <a href="/tags/ci/" style="font-size: 10px;">ci</a> <a href="/tags/cleanup/" style="font-size: 10px;">cleanup</a> <a href="/tags/clever-code/" style="font-size: 10px;">clever-code</a> <a href="/tags/cloud-computing/" style="font-size: 10px;">cloud-computing</a> <a href="/tags/cluster/" style="font-size: 10px;">cluster</a> <a href="/tags/command-t/" style="font-size: 10px;">command-t</a> <a href="/tags/communication/" style="font-size: 10px;">communication</a> <a href="/tags/console/" style="font-size: 10px;">console</a> <a href="/tags/copy/" style="font-size: 10px;">copy</a> <a href="/tags/coreos/" style="font-size: 10px;">coreos</a> <a href="/tags/curl/" style="font-size: 10px;">curl</a> <a href="/tags/datadog/" style="font-size: 10px;">datadog</a> <a href="/tags/debug/" style="font-size: 10px;">debug</a> <a href="/tags/design/" style="font-size: 10px;">design</a> <a href="/tags/devise/" style="font-size: 10px;">devise</a> <a href="/tags/diff/" style="font-size: 10px;">diff</a> <a href="/tags/difficulty/" style="font-size: 10px;">difficulty</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/downtime-calculation/" style="font-size: 10px;">downtime calculation</a> <a href="/tags/drag-and-drop/" style="font-size: 10px;">drag-and-drop</a> <a href="/tags/eager-load/" style="font-size: 10px;">eager-load</a> <a href="/tags/ecommerce/" style="font-size: 10px;">ecommerce</a> <a href="/tags/elastic-object/" style="font-size: 10px;">elastic object</a> <a href="/tags/ets/" style="font-size: 11.25px;">ets</a> <a href="/tags/experiment/" style="font-size: 10px;">experiment</a> <a href="/tags/explore/" style="font-size: 10px;">explore</a> <a href="/tags/fear/" style="font-size: 10px;">fear</a> <a href="/tags/filter/" style="font-size: 10px;">filter</a> <a href="/tags/flash/" style="font-size: 10px;">flash,</a> <a href="/tags/for-sohel/" style="font-size: 11.25px;">for-sohel</a> <a href="/tags/form/" style="font-size: 10px;">form</a> <a href="/tags/free-lunch/" style="font-size: 10px;">free-lunch</a> <a href="/tags/functional/" style="font-size: 10px;">functional</a> <a href="/tags/getsimpleform/" style="font-size: 10px;">getsimpleform</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/go/" style="font-size: 13.75px;">go</a> <a href="/tags/godoc/" style="font-size: 10px;">godoc</a> <a href="/tags/gtimelog/" style="font-size: 10px;">gtimelog</a> <a href="/tags/hack/" style="font-size: 12.5px;">hack</a> <a href="/tags/hash/" style="font-size: 10px;">hash</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/iex/" style="font-size: 10px;">iex</a> <a href="/tags/import/" style="font-size: 10px;">import</a> <a href="/tags/india/" style="font-size: 10px;">india</a> <a href="/tags/inotify/" style="font-size: 10px;">inotify</a> <a href="/tags/javascript/" style="font-size: 12.5px;">javascript</a> <a href="/tags/jquery/" style="font-size: 10px;">jquery</a> <a href="/tags/lazy/" style="font-size: 10px;">lazy</a> <a href="/tags/learn/" style="font-size: 12.5px;">learn</a> <a href="/tags/learn-go/" style="font-size: 10px;">learn-go</a> <a href="/tags/lego/" style="font-size: 10px;">lego</a> <a href="/tags/libcluster/" style="font-size: 10px;">libcluster</a> <a href="/tags/limit/" style="font-size: 10px;">limit</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/magic-strings/" style="font-size: 10px;">magic strings</a> <a href="/tags/many-to-many/" style="font-size: 12.5px;">many_to_many</a> <a href="/tags/map/" style="font-size: 10px;">map</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/metaprogramming/" style="font-size: 10px;">metaprogramming</a> <a href="/tags/mundane-code/" style="font-size: 10px;">mundane-code</a> <a href="/tags/music/" style="font-size: 10px;">music</a> <a href="/tags/mutt/" style="font-size: 10px;">mutt</a> <a href="/tags/open-struct/" style="font-size: 10px;">open struct</a> <a href="/tags/partial-table/" style="font-size: 10px;">partial table</a> <a href="/tags/pbcopy/" style="font-size: 10px;">pbcopy</a> <a href="/tags/perception/" style="font-size: 10px;">perception,</a> <a href="/tags/pg-dump/" style="font-size: 11.25px;">pg_dump</a> <a href="/tags/pg-restore/" style="font-size: 10px;">pg_restore</a> <a href="/tags/postgresql/" style="font-size: 12.5px;">postgresql</a> <a href="/tags/postgresql/" style="font-size: 10px;">postgresql,</a> <a href="/tags/production/" style="font-size: 10px;">production</a> <a href="/tags/prompt/" style="font-size: 10px;">prompt</a> <a href="/tags/ps1/" style="font-size: 10px;">ps1</a> <a href="/tags/psql/" style="font-size: 11.25px;">psql</a> <a href="/tags/rails/" style="font-size: 15px;">rails</a> <a href="/tags/raspberry-pi/" style="font-size: 10px;">raspberry pi</a> <a href="/tags/raw/" style="font-size: 10px;">raw</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/reduce/" style="font-size: 10px;">reduce</a> <a href="/tags/relationships/" style="font-size: 12.5px;">relationships</a> <a href="/tags/rename/" style="font-size: 10px;">rename</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/review/" style="font-size: 10px;">review</a> <a href="/tags/row-number/" style="font-size: 10px;">row_number</a> <a href="/tags/rspec/" style="font-size: 11.25px;">rspec</a> <a href="/tags/ruby/" style="font-size: 15px;">ruby</a> <a href="/tags/rvm/" style="font-size: 10px;">rvm</a> <a href="/tags/sample/" style="font-size: 10px;">sample</a> <a href="/tags/script/" style="font-size: 10px;">script</a> <a href="/tags/server/" style="font-size: 10px;">server</a> <a href="/tags/shiny/" style="font-size: 10px;">shiny,</a> <a href="/tags/simpleform/" style="font-size: 10px;">simpleform</a> <a href="/tags/sleep/" style="font-size: 10px;">sleep</a> <a href="/tags/socks5/" style="font-size: 10px;">socks5</a> <a href="/tags/software/" style="font-size: 10px;">software</a> <a href="/tags/solving/" style="font-size: 10px;">solving</a> <a href="/tags/submodules/" style="font-size: 10px;">submodules</a> <a href="/tags/substance/" style="font-size: 10px;">substance</a> <a href="/tags/sugar-coat/" style="font-size: 10px;">sugar-coat</a> <a href="/tags/table/" style="font-size: 10px;">table</a> <a href="/tags/temp-table/" style="font-size: 10px;">temp table</a> <a href="/tags/temperature/" style="font-size: 10px;">temperature</a> <a href="/tags/template/" style="font-size: 10px;">template</a> <a href="/tags/templates/" style="font-size: 10px;">templates</a> <a href="/tags/temptation/" style="font-size: 10px;">temptation</a> <a href="/tags/terminal/" style="font-size: 10px;">terminal</a> <a href="/tags/thinking/" style="font-size: 10px;">thinking</a> <a href="/tags/time/" style="font-size: 11.25px;">time</a> <a href="/tags/time-overlap/" style="font-size: 10px;">time-overlap</a> <a href="/tags/tmux/" style="font-size: 10px;">tmux</a> <a href="/tags/todo-list/" style="font-size: 10px;">todo-list</a> <a href="/tags/travis/" style="font-size: 10px;">travis</a> <a href="/tags/update/" style="font-size: 11.25px;">update</a> <a href="/tags/upstart/" style="font-size: 10px;">upstart</a> <a href="/tags/usability/" style="font-size: 10px;">usability,</a> <a href="/tags/util/" style="font-size: 10px;">util</a> <a href="/tags/utility/" style="font-size: 11.25px;">utility</a> <a href="/tags/ux/" style="font-size: 10px;">ux</a> <a href="/tags/viewer/" style="font-size: 10px;">viewer</a> <a href="/tags/vim/" style="font-size: 13.75px;">vim</a> <a href="/tags/virtualization/" style="font-size: 10px;">virtualization</a> <a href="/tags/watch/" style="font-size: 10px;">watch</a> <a href="/tags/workflow/" style="font-size: 10px;">workflow</a> <a href="/tags/xclip/" style="font-size: 11.25px;">xclip</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/09/">September 2012</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/06/">June 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/03/">March 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/02/">February 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/01/">January 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/12/">December 2011</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/11/">November 2011</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/10/">October 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/08/">August 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/07/">July 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/06/">June 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/05/">May 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/04/">April 2011</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/03/">March 2011</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/02/">February 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/01/">January 2011</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/12/">December 2010</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/11/">November 2010</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/10/">October 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/09/">September 2010</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/07/">July 2010</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2010/06/">June 2010</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/12/">December 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/09/">September 2009</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/08/">August 2009</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/07/">July 2009</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/04/">April 2009</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/aws/" rel="tag">AWS</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/advent-of-code/" rel="tag">Advent Of Code</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/advent-of-code/" rel="tag">Advent of Code</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/analyze/" rel="tag">Analyze</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/atom/" rel="tag">Atom</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aurora/" rel="tag">Aurora</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/auto-renew/" rel="tag">Auto renew</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/automatic-generation/" rel="tag">Automatic Generation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/backpressure/" rel="tag">Backpressure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash-completion/" rel="tag">Bash completion</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bastion/" rel="tag">Bastion</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/baton/" rel="tag">Baton</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bench/" rel="tag">Bench</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/benchmark/" rel="tag">Benchmark</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/binary/" rel="tag">Binary</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bits/" rel="tag">Bits</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/blog/" rel="tag">Blog</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/callbacks/" rel="tag">Callbacks</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/case-insensitive/" rel="tag">Case insensitive</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cassette/" rel="tag">Cassette</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cluster/" rel="tag">Cluster</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/concatenate/" rel="tag">Concatenate</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/concurrency/" rel="tag">Concurrency</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/copy/" rel="tag">Copy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cowboy/" rel="tag">Cowboy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dry/" rel="tag">DRY</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/database/" rel="tag">Database</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/" rel="tag">Debug</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deploy/" rel="tag">Deploy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/distillery/" rel="tag">Distillery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/distributed/" rel="tag">Distributed</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/documentation/" rel="tag">Documentation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/duplication/" rel="tag">Duplication</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ec2/" rel="tag">EC2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ecs/" rel="tag">ECS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/erb/" rel="tag">ERB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ecto/" rel="tag">Ecto</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elixir/" rel="tag">Elixir</a><span class="tag-list-count">32</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elm/" rel="tag">Elm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/email/" rel="tag">Email</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/enqueue/" rel="tag">Enqueue</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/enum/" rel="tag">Enum</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/environment-loader/" rel="tag">Environment Loader</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/environment-variables/" rel="tag">Environment Variables</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/erlang/" rel="tag">Erlang</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/error/" rel="tag">Error</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exvcr/" rel="tag">ExVCR</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fast/" rel="tag">Fast</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fizzbuzz/" rel="tag">FizzBuzz</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/functional-programming/" rel="tag">Functional Programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/genserver/" rel="tag">GenServer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github-pages/" rel="tag">GitHub Pages</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">Go</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/google-chrome/" rel="tag">Google Chrome</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/guard/" rel="tag">Guard</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hmac/" rel="tag">HMAC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/heroku/" rel="tag">Heroku</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hex/" rel="tag">Hex</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hotkeys/" rel="tag">Hotkeys</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/how-to/" rel="tag">How To</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/how-to/" rel="tag">How to</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iex/" rel="tag">IEx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/irb/" rel="tag">IRB</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/index/" rel="tag">Index</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/isolated/" rel="tag">Isolated</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json/" rel="tag">JSON</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/key-transform/" rel="tag">Key Transform</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/key-value/" rel="tag">Key-Value</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/large/" rel="tag">Large</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/learn/" rel="tag">Learn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lets-encrypt/" rel="tag">Lets encrypt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lists/" rel="tag">Lists</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lookup-tables/" rel="tag">Lookup tables</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/md5/" rel="tag">MD5</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/" rel="tag">Map</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/meetup/" rel="tag">Meetup</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-cached-tables/" rel="tag">Memory Cached Tables</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/migration/" rel="tag">Migration</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mix/" rel="tag">Mix</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/multiple/" rel="tag">Multiple</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">Network</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nokogiri/" rel="tag">Nokogiri</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/order/" rel="tag">Order</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pdf/" rel="tag">PDF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pandora/" rel="tag">Pandora</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/parameter-store/" rel="tag">Parameter Store</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pattern-matching/" rel="tag">Pattern matching</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pearls/" rel="tag">Pearls</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perf/" rel="tag">Perf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/performance/" rel="tag">Performance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phoenix/" rel="tag">Phoenix</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pianobar/" rel="tag">Pianobar</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pipelines/" rel="tag">Pipelines</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/plug/" rel="tag">Plug</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgres/" rel="tag">Postgres</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgres-provider/" rel="tag">Postgres provider</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgresql/" rel="tag">Postgresql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/presentation/" rel="tag">Presentation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/process/" rel="tag">Process</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/product/" rel="tag">Product</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proxy/" rel="tag">Proxy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proxyjump/" rel="tag">ProxyJump</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pry/" rel="tag">Pry</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">Python</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rds/" rel="tag">RDS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rails/" rel="tag">Rails</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rails-migrations/" rel="tag">Rails Migrations</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">Redis</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/restricted/" rel="tag">Restricted</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/restricted-subdomains/" rel="tag">Restricted Subdomains</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/retrieval/" rel="tag">Retrieval</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ruby/" rel="tag">Ruby</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/" rel="tag">SSH</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/saas-tip/" rel="tag">SaaS Tip</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/secrets/" rel="tag">Secrets</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/semver/" rel="tag">SemVer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/" rel="tag">Server</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sidekiq/" rel="tag">Sidekiq</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sign-request/" rel="tag">Sign Request</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sleep/" rel="tag">Sleep</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/speed/" rel="tag">Speed</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/startup/" rel="tag">Startup</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/static-site-generator/" rel="tag">Static Site Generator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/static-sites/" rel="tag">Static Sites</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/string/" rel="tag">String</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/structure/" rel="tag">Structure</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/til/" rel="tag">TIL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tags/" rel="tag">Tags</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/task/" rel="tag">Task</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/terraform/" rel="tag">Terraform</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ticker/" rel="tag">Ticker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/timeout/" rel="tag">Timeout</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tip/" rel="tag">Tip</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tmux/" rel="tag">Tmux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/user/" rel="tag">User</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/username/" rel="tag">Username</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/version/" rel="tag">Version</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">Vim</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-apps/" rel="tag">Web apps</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpipe/" rel="tag">Webpipe</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xml/" rel="tag">Xml</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xml-pluck/" rel="tag">Xml Pluck</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ajax/" rel="tag">ajax,</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/" rel="tag">algorithm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/angularjs/" rel="tag">angularjs</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/api/" rel="tag">api</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/authenticate/" rel="tag">authenticate</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/automate/" rel="tag">automate</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/automatic/" rel="tag">automatic</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/banshee/" rel="tag">banshee,</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/barefooters/" rel="tag">barefooters</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/" rel="tag">bash</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/batch/" rel="tag">batch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bookmarklet/" rel="tag">bookmarklet</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/books/" rel="tag">books</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/brute-force/" rel="tag">brute-force</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ci/" rel="tag">ci</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cleanup/" rel="tag">cleanup</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clever-code/" rel="tag">clever-code</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cloud-computing/" rel="tag">cloud-computing</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cluster/" rel="tag">cluster</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/command-t/" rel="tag">command-t</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/communication/" rel="tag">communication</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/console/" rel="tag">console</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/copy/" rel="tag">copy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/coreos/" rel="tag">coreos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/curl/" rel="tag">curl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/datadog/" rel="tag">datadog</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug/" rel="tag">debug</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design/" rel="tag">design</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/devise/" rel="tag">devise</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/diff/" rel="tag">diff</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/difficulty/" rel="tag">difficulty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/downtime-calculation/" rel="tag">downtime calculation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/drag-and-drop/" rel="tag">drag-and-drop</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eager-load/" rel="tag">eager-load</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ecommerce/" rel="tag">ecommerce</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elastic-object/" rel="tag">elastic object</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ets/" rel="tag">ets</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/experiment/" rel="tag">experiment</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/explore/" rel="tag">explore</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fear/" rel="tag">fear</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/filter/" rel="tag">filter</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flash/" rel="tag">flash,</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/for-sohel/" rel="tag">for-sohel</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/form/" rel="tag">form</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/free-lunch/" rel="tag">free-lunch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/functional/" rel="tag">functional</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/getsimpleform/" rel="tag">getsimpleform</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/godoc/" rel="tag">godoc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gtimelog/" rel="tag">gtimelog</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hack/" rel="tag">hack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hash/" rel="tag">hash</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/" rel="tag">http</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iex/" rel="tag">iex</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/import/" rel="tag">import</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/india/" rel="tag">india</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/inotify/" rel="tag">inotify</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jquery/" rel="tag">jquery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lazy/" rel="tag">lazy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/learn/" rel="tag">learn</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/learn-go/" rel="tag">learn-go</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lego/" rel="tag">lego</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/libcluster/" rel="tag">libcluster</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/limit/" rel="tag">limit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/magic-strings/" rel="tag">magic strings</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/many-to-many/" rel="tag">many_to_many</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/map/" rel="tag">map</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/" rel="tag">markdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/metaprogramming/" rel="tag">metaprogramming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mundane-code/" rel="tag">mundane-code</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/music/" rel="tag">music</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mutt/" rel="tag">mutt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/open-struct/" rel="tag">open struct</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/partial-table/" rel="tag">partial table</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pbcopy/" rel="tag">pbcopy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/perception/" rel="tag">perception,</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pg-dump/" rel="tag">pg_dump</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pg-restore/" rel="tag">pg_restore</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgresql/" rel="tag">postgresql,</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/production/" rel="tag">production</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prompt/" rel="tag">prompt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ps1/" rel="tag">ps1</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/psql/" rel="tag">psql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rails/" rel="tag">rails</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberry-pi/" rel="tag">raspberry pi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raw/" rel="tag">raw</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reduce/" rel="tag">reduce</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/relationships/" rel="tag">relationships</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rename/" rel="tag">rename</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/" rel="tag">reverse</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/review/" rel="tag">review</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/row-number/" rel="tag">row_number</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rspec/" rel="tag">rspec</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ruby/" rel="tag">ruby</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rvm/" rel="tag">rvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sample/" rel="tag">sample</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/script/" rel="tag">script</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/server/" rel="tag">server</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shiny/" rel="tag">shiny,</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/simpleform/" rel="tag">simpleform</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sleep/" rel="tag">sleep</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socks5/" rel="tag">socks5</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software/" rel="tag">software</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solving/" rel="tag">solving</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/submodules/" rel="tag">submodules</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/substance/" rel="tag">substance</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sugar-coat/" rel="tag">sugar-coat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/table/" rel="tag">table</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/temp-table/" rel="tag">temp table</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/temperature/" rel="tag">temperature</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/template/" rel="tag">template</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/templates/" rel="tag">templates</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/temptation/" rel="tag">temptation</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/terminal/" rel="tag">terminal</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thinking/" rel="tag">thinking</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/time/" rel="tag">time</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/time-overlap/" rel="tag">time-overlap</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tmux/" rel="tag">tmux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/todo-list/" rel="tag">todo-list</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/travis/" rel="tag">travis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/update/" rel="tag">update</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/upstart/" rel="tag">upstart</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/usability/" rel="tag">usability,</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/util/" rel="tag">util</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/utility/" rel="tag">utility</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ux/" rel="tag">ux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewer/" rel="tag">viewer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtualization/" rel="tag">virtualization</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/watch/" rel="tag">watch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/workflow/" rel="tag">workflow</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xclip/" rel="tag">xclip</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
</aside>

        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Khaja Minhajuddin<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/about/" class="mobile-nav-link">About</a>
  
    <a href="/about/#Contact_Me" class="mobile-nav-link">Contact</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'minhajuddin';
  
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>
